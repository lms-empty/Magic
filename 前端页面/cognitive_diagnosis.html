<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>çŸ¥è¯†ç‚¹æŒæ¡æ£€æµ‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#3B82F6",
              secondary: "#10B981",
              accent: "#8B5CF6",
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&family=Noto+Sans+SC:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap");

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body,
      html {
        height: 100vh;
        font-family: "Inter", "Noto Sans SC", sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        color: #1e293b;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        overflow: hidden;
      }

      .font-display {
        font-family: "Poppins", "Noto Sans SC", sans-serif;
        font-weight: 800;
        letter-spacing: -0.02em;
      }

      .font-heading {
        font-family: "Poppins", "Noto Sans SC", sans-serif;
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .font-mono {
        font-family: "JetBrains Mono", "Noto Sans SC", monospace;
      }

      .text-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      #main-container {
        width: 90%;
        max-width: 900px;
        height: 90vh;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 24px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .header {
        text-align: center;
        padding: 30px 40px 20px;
        background: linear-gradient(135deg, #f8faff 0%, #f1f6fe 100%);
        border-bottom: 2px solid #e2e8f0;
        flex-shrink: 0;
      }

      .header h1 {
        font-size: 2.2rem;
        margin-bottom: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header p {
        color: #64748b;
        font-size: 1.1rem;
        font-weight: 500;
      }

      #content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 40px;
        overflow-y: auto;
      }

      #progress-bar-container {
        width: 100%;
        height: 12px;
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 32px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        flex-shrink: 0;
      }

      #progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      }

      #question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e2e8f0;
        flex-shrink: 0;
      }

      #question-number {
        font-weight: 600;
        color: #1e293b;
        font-size: 1.2rem;
        font-family: "Poppins", "Noto Sans SC", sans-serif;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      #timer-container {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 0.9rem;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        font-weight: 600;
        font-family: "JetBrains Mono", monospace;
      }

      #timer-container.running {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1d4ed8;
        border-color: rgba(59, 130, 246, 0.2);
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15);
      }

      #timer-container.submitted {
        background: #e9f3ed;
        color: #047857;
        border-color: rgba(16, 185, 129, 0.4);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.15);
      }

      .timer-icon {
        font-size: 1.1rem;
      }

      #question-container {
        width: 100%;
        font-size: 1.3rem;
        line-height: 1.75;
        color: #1e293b;
        margin-bottom: 32px;
        padding: 24px;
        background: #f8faff;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
        border: 2px solid rgba(121, 138, 241, 0.15);
        font-weight: 500;
        backdrop-filter: blur(8px);
        max-height: 300px;
        overflow-y: auto;
        flex-shrink: 0;
      }

      .question-type-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 16px;
        font-family: "Inter", "Noto Sans SC", sans-serif;
      }

      .choice-question .question-type-badge {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1d4ed8;
        border: 1px solid rgba(59, 130, 246, 0.3);
      }

      .judgment-question .question-type-badge {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #d97706;
        border: 1px solid rgba(217, 119, 6, 0.3);
      }

      .short-answer-question .question-type-badge,
      .proof-question .question-type-badge {
        background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
        color: #5b21b6;
        border: 1px solid rgba(139, 92, 246, 0.3);
      }

      #answer-container {
        width: 100%;
        margin-bottom: 16px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        border: 2px solid #e2e8f0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 400px;
        overflow-y: auto;
        flex-shrink: 0;
      }

      #answer-container.disabled {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        opacity: 0.7;
      }

      .option-item {
        padding: 18px 22px;
        border-bottom: 1px solid #f1f5f9;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 14px;
        font-size: 1.1rem;
        color: #374151;
        font-weight: 500;
      }

      .option-item:last-child {
        border-bottom: none;
      }

      .option-item:hover {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        transform: translateX(4px);
      }

      .option-item.selected {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1d4ed8;
        font-weight: 600;
        transform: translateX(4px);
        box-shadow: inset 4px 0 0 #3b82f6;
      }

      .option-item.disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }

      .option-item.disabled:hover {
        background: none;
        transform: none;
      }

      .option-radio {
        width: 22px;
        height: 22px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
      }

      .option-item.selected .option-radio {
        border-color: #3b82f6;
        background: #3b82f6;
      }

      .option-item.selected .option-radio::after {
        content: "";
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: white;
      }

      .option-label {
        font-weight: 600;
        color: #374151;
        margin-right: 10px;
        min-width: 28px;
      }

      .option-text {
        flex: 1;
      }

      .text-answer-container {
        padding: 20px;
      }

      .text-answer-label {
        display: block;
        margin-bottom: 12px;
        font-weight: 600;
        color: #374151;
      }

      .text-answer-input {
        width: 100%;
        min-height: 120px;
        padding: 16px;
        border: 2px solid #d1d5db;
        border-radius: 12px;
        font-size: 1.1rem;
        font-family: "Inter", "Noto Sans SC", sans-serif;
        resize: vertical;
        transition: border-color 0.3s ease;
      }

      .text-answer-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }

      .text-answer-input:disabled {
        background-color: #f1f5f9;
        cursor: not-allowed;
      }

      #feedback {
        min-height: 40px;
        font-weight: 600;
        margin-bottom: 24px;
        font-size: 1.1rem;
        padding: 0 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px;
        display: flex;
        align-items: center;
        flex-shrink: 0;
      }

      .success-feedback {
        color: #047857;
        background: #e9f3ed;
        padding: 12px 20px;
        border-left: 4px solid rgba(16, 185, 129, 0.6);
      }

      .error-feedback {
        color: #dc2626;
        background: #f5e8eb;
        padding: 12px 20px;
        border-left: 4px solid rgba(239, 68, 68, 0.6);
      }

      .button-group {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: auto;
        padding-top: 20px;
        flex-wrap: wrap;
        flex-shrink: 0;
      }

      .blue-btn {
        padding: 16px 32px;
        border: none;
        border-radius: 16px;
        font-weight: 600;
        cursor: pointer;
        font-size: 1.1rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 12px;
        font-family: "Poppins", "Noto Sans SC", sans-serif;
        backdrop-filter: blur(8px);
        border: 2px solid transparent;
      }

      .blue-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
      }

      .blue-btn:active {
        transform: translateY(0);
      }

      #prev-btn {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        color: #475569;
        border-color: #e2e8f0;
      }

      #prev-btn:hover {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        border-color: #cbd5e1;
      }

      #next-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border-color: #1d4ed8;
      }

      #next-btn:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
        box-shadow: 0 12px 30px rgba(59, 130, 246, 0.25);
      }

      #hint-btn {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        color: white;
        border-color: #dc2626;
      }

      #hint-btn:hover {
        background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%);
        box-shadow: 0 12px 30px rgba(249, 115, 22, 0.25);
      }

      #hint-btn:disabled {
        background: linear-gradient(135deg, #fed7aa 0%, #fde68a 100%);
        cursor: not-allowed;
        opacity: 0.7;
        color: #78716c;
      }

      #submit-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        display: none;
        border-color: #047857;
      }

      #submit-btn:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        box-shadow: 0 12px 30px rgba(16, 185, 129, 0.25);
      }

      #submit-btn:disabled {
        background: linear-gradient(135deg, #86efac 0%, #6ee7b7 100%);
        cursor: not-allowed;
        opacity: 0.7;
      }

      #view-report-btn {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        display: none;
        border-color: #6d28d9;
      }

      #view-report-btn:hover {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        box-shadow: 0 12px 30px rgba(139, 92, 246, 0.25);
      }

      .btn-icon {
        display: inline-flex;
        font-size: 1.2rem;
      }

      /* æŠ¥å‘Šæ¨¡æ€æ¡†æ ·å¼ */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 24px;
        padding: 40px;
        width: 85%;
        max-width: 800px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.8);
      }

      .modal-header {
        font-size: 1.8rem;
        font-weight: 800;
        margin-bottom: 24px;
        color: #1e293b;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: "Poppins", "Noto Sans SC", sans-serif;
        letter-spacing: -0.01em;
      }

      .close-modal {
        font-size: 2rem;
        cursor: pointer;
        color: #64748b;
        transition: all 0.3s ease;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f1f5f9;
      }

      .close-modal:hover {
        color: #dc2626;
        background: #fee2e2;
        transform: scale(1.1);
      }

      .report-item {
        padding: 20px;
        border-bottom: 2px solid #f1f5f9;
        line-height: 1.7;
        border-radius: 16px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
      }

      .report-item.correct {
        background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
        border-left: 6px solid #10b981;
        border-bottom-color: #a7f3d0;
      }

      .report-item.incorrect {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        border-left: 6px solid #ef4444;
        border-bottom-color: #fca5a5;
      }

      .report-question {
        font-weight: 600;
        margin-bottom: 12px;
        font-size: 1.1rem;
        color: #1e293b;
        font-family: "Poppins", "Noto Sans SC", sans-serif;
      }

      .report-answer {
        font-size: 1rem;
        margin-top: 8px;
        color: #475569;
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }

      .report-label {
        font-weight: 600;
        min-width: 80px;
        font-family: "Inter", "Noto Sans SC", sans-serif;
      }

      .report-value {
        flex: 1;
        font-family: "JetBrains Mono", monospace;
        font-weight: 500;
      }

      .report-explanation {
        font-size: 1rem;
        margin-top: 12px;
        color: #475569;
        padding: 16px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 12px;
        border-left: 4px solid #3b82f6;
      }

      .report-explanation-text {
        margin-top: 8px;
        line-height: 1.6;
        color: #374151;
        font-family: "Inter", "Noto Sans SC", sans-serif;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .report-correct {
        color: #047857;
        font-weight: 600;
      }

      .report-incorrect {
        color: #dc2626;
        font-weight: 600;
      }

      .report-detail {
        font-size: 0.9rem;
        color: #64748b;
        display: flex;
        gap: 20px;
        margin-top: 8px;
        font-family: "JetBrains Mono", monospace;
      }

      .report-stats {
        display: flex;
        justify-content: space-around;
        margin: 24px 0;
        padding: 24px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 20px;
        font-weight: 600;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
        border: 2px solid #e2e8f0;
      }

      .stat-item {
        text-align: center;
        padding: 8px;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 800;
        font-family: "Poppins", "Noto Sans SC", sans-serif;
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #64748b;
        font-weight: 500;
      }

      .stat-correct .stat-value {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .stat-time .stat-value {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .stat-hints .stat-value {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* è¯Šæ–­ç»“æœå¼¹çª—æ ·å¼ */
      .diagnosis-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(12px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .diagnosis-content {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 24px;
        padding: 50px 40px;
        width: 90%;
        max-width: 800px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.8);
        text-align: center;
        position: relative;
        animation: modalSlideIn 0.4s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .diagnosis-header {
        margin-bottom: 30px;
      }

      .diagnosis-icon {
        font-size: 5rem;
        margin-bottom: 20px;
        display: block;
        animation: resultFloat 3s ease-in-out infinite;
      }

      @keyframes resultFloat {
        0%,
        100% {
          transform: translateY(0px) scale(1);
        }
        50% {
          transform: translateY(-10px) scale(1.05);
        }
      }

      .diagnosis-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 16px;
        font-family: "Poppins", "Noto Sans SC", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .diagnosis-result {
        background: linear-gradient(135deg, #f8faff 0%, #f1f6fe 100%);
        border-radius: 20px;
        padding: 30px;
        margin: 30px 0;
        border: 2px solid rgba(59, 130, 246, 0.2);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.1);
        text-align: left;
      }

      .diagnosis-result h3 {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 20px;
        font-family: "Poppins", "Noto Sans SC", sans-serif;
        text-align: center;
      }

      .diagnosis-text {
        color: #374151;
        font-size: 1.1rem;
        line-height: 1.7;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .close-diagnosis {
        font-size: 2rem;
        cursor: pointer;
        color: #64748b;
        transition: all 0.3s ease;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f1f5f9;
        position: absolute;
        top: 20px;
        right: 20px;
      }

      .close-diagnosis:hover {
        color: #dc2626;
        background: #fee2e2;
        transform: scale(1.1);
      }

      .diagnosis-actions {
        margin-top: 30px;
        display: flex;
        justify-content: center;
        gap: 20px;
      }

      .diagnosis-btn {
        padding: 16px 32px;
        border: none;
        border-radius: 16px;
        font-weight: 600;
        cursor: pointer;
        font-size: 1.1rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        font-family: "Poppins", "Noto Sans SC", sans-serif;
        min-width: 150px;
      }

      .diagnosis-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      }

      .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border: 2px solid #1e40af;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
        box-shadow: 0 15px 35px rgba(59, 130, 246, 0.3);
      }

      /* åŠ è½½åŠ¨ç”» */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        #main-container {
          width: 95%;
          height: 95vh;
          margin: 10px;
        }

        .header {
          padding: 20px 24px 16px;
        }

        .header h1 {
          font-size: 1.8rem;
        }

        .header p {
          font-size: 1rem;
        }

        #content {
          padding: 24px;
        }

        #question-container {
          font-size: 1.1rem;
          padding: 20px;
        }

        .option-item {
          padding: 16px 18px;
          font-size: 1rem;
        }

        .button-group {
          flex-direction: column;
        }

        .blue-btn {
          width: 100%;
          justify-content: center;
        }

        .diagnosis-content {
          width: 95%;
          padding: 30px 20px;
        }

        .diagnosis-title {
          font-size: 1.8rem;
        }

        .diagnosis-actions {
          flex-direction: column;
        }

        .diagnosis-btn {
          width: 100%;
        }

        .header-right {
          gap: 8px;
        }

        #timer-container {
          padding: 8px 12px;
          font-size: 0.8rem;
        }

        .modal-content {
          width: 95%;
          padding: 30px 20px;
        }
      }

      /* æ»šåŠ¨æ¡ç¾åŒ– */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
      }
    </style>
  </head>
  <body>
    <div id="main-container">
      <!-- é¡µé¢å¤´éƒ¨ -->
      <div class="header">
        <h1 class="font-display">çŸ¥è¯†ç‚¹æŒæ¡æ£€æµ‹</h1>
        <p>è¯·è®¤çœŸç­”é¢˜ï¼Œç³»ç»Ÿå°†ä¸ºæ‚¨è¯Šæ–­çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ</p>
      </div>

      <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
      <div id="content">
        <!-- è¿›åº¦æ¡ -->
        <div id="progress-bar-container">
          <div id="progress-bar"></div>
        </div>

        <!-- é¢˜ç›®å¤´éƒ¨ä¿¡æ¯ -->
        <div id="question-header">
          <div id="question-number" class="font-heading"></div>
          <div class="header-right">
            <div id="timer-container">
              <span class="timer-icon">â±</span>
              <span id="timer">0ç§’</span>
            </div>
          </div>
        </div>

        <!-- é¢˜ç›®å®¹å™¨ -->
        <div id="question-container" class="font-mono">
          <div class="question-type-badge">é€‰æ‹©é¢˜</div>
          <div id="question-text"></div>
        </div>

        <!-- ç­”æ¡ˆé€‰é¡¹å®¹å™¨ -->
        <div id="answer-container">
          <!-- é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- åé¦ˆä¿¡æ¯ -->
        <div id="feedback"></div>

        <!-- æ“ä½œæŒ‰é’®ç»„ -->
        <div class="button-group">
          <button id="hint-btn" class="blue-btn">
            <span class="btn-icon">ğŸ’¡</span> æŸ¥çœ‹æç¤º
          </button>
          <button id="prev-btn" class="blue-btn">
            <span class="btn-icon">â—€</span> ä¸Šä¸€é¢˜
          </button>
          <button id="next-btn" class="blue-btn">
            <span class="btn-icon">â–¶</span> ä¸‹ä¸€é¢˜
          </button>
          <button id="submit-btn" class="blue-btn">
            <span class="btn-icon">âœ“</span> æäº¤ç­”æ¡ˆ
          </button>
          <button id="view-report-btn" class="blue-btn">
            <span class="btn-icon">ğŸ“Š</span> æŸ¥çœ‹åšé¢˜æƒ…å†µ
          </button>
        </div>
      </div>
    </div>

    <!-- åšé¢˜æƒ…å†µæŠ¥å‘Šæ¨¡æ€æ¡† -->
    <div id="report-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span class="font-display text-gradient">åšé¢˜æƒ…å†µæŠ¥å‘Š</span>
          <span class="close-modal">&times;</span>
        </div>
        <div id="report-container"></div>
      </div>
    </div>

    <!-- è¯Šæ–­ç»“æœå¼¹çª— -->
    <div id="diagnosis-modal" class="diagnosis-modal">
      <div class="diagnosis-content">
        <div class="close-diagnosis">&times;</div>
        <div class="diagnosis-header">
          <span class="diagnosis-icon">ğŸ¯</span>
          <div class="diagnosis-title">çŸ¥è¯†ç‚¹æŒæ¡è¯Šæ–­ç»“æœ</div>
        </div>
        <div class="diagnosis-result">
          <h3>è¯Šæ–­æŠ¥å‘Š</h3>
          <div id="diagnosis-text" class="diagnosis-text">
            <!-- è¯Šæ–­ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
          </div>
        </div>
        <div class="diagnosis-actions">
          <button id="close-diagnosis-btn" class="diagnosis-btn btn-primary">
            æˆ‘çŸ¥é“äº†
          </button>
        </div>
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let questions = [];
      let currentIndex = 0;
      let timerInterval = null;
      let userAnswers = [];
      let hintCounts = [];
      let startTime = Date.now();
      let isCompleted = false; // æ ‡è¯†æ˜¯å¦å·²å®Œæˆæ£€æµ‹
      let diagnosisResult = null; // å­˜å‚¨è¯Šæ–­ç»“æœ

      // DOMå…ƒç´ 
      const questionContainer = document.getElementById("question-container");
      const questionText = document.getElementById("question-text");
      const questionNumberEl = document.getElementById("question-number");
      const answerContainer = document.getElementById("answer-container");
      const feedbackEl = document.getElementById("feedback");
      const timerEl = document.getElementById("timer");
      const timerContainer = document.getElementById("timer-container");
      const progressBar = document.getElementById("progress-bar");

      const prevBtn = document.getElementById("prev-btn");
      const nextBtn = document.getElementById("next-btn");
      const submitBtn = document.getElementById("submit-btn");
      const hintBtn = document.getElementById("hint-btn");
      const viewReportBtn = document.getElementById("view-report-btn");

      // æŠ¥å‘Šæ¨¡æ€æ¡†å…ƒç´ 
      const reportModal = document.getElementById("report-modal");
      const reportContainer = document.getElementById("report-container");
      const closeModalBtn = document.querySelector(".close-modal");

      // è¯Šæ–­ç»“æœå¼¹çª—å…ƒç´ 
      const diagnosisModal = document.getElementById("diagnosis-modal");
      const diagnosisText = document.getElementById("diagnosis-text");
      const closeDiagnosisBtn = document.getElementById("close-diagnosis-btn");
      const closeDiagnosis = document.querySelector(".close-diagnosis");

      // APIé…ç½®
      const apiUrl = "http://172.20.192.249:3000/api/get_temp_questions";
      const submitUrl = "http://172.20.192.249:3000/api/detection/submit";
      let skill = "";
      let userId = "";

      // æŸ¥çœ‹æç¤º/è¯Šæ–­ç»“æœåŠŸèƒ½
      hintBtn.onclick = () => {
        if (isCompleted && diagnosisResult) {
          // å¦‚æœå·²å®Œæˆæ£€æµ‹ï¼Œæ˜¾ç¤ºè¯Šæ–­ç»“æœ
          showDiagnosisResult(diagnosisResult);
        } else {
          // å¦åˆ™æ˜¾ç¤ºæç¤º
          if (currentIndex >= 0 && currentIndex < questions.length) {
            hintCounts[currentIndex] = (hintCounts[currentIndex] || 0) + 1;
            feedbackEl.textContent =
              "ğŸ’¡ æç¤ºï¼šè¯·æ³¨æ„é¢˜ç›®ä¸­çš„å…³é”®è¯ï¼Œè®¤çœŸåˆ†æè§£é¢˜æ€è·¯ï¼";
            feedbackEl.className = "success-feedback";

            setTimeout(() => {
              feedbackEl.textContent = "";
              feedbackEl.className = "";
            }, 4000);
          }
        }
      };

      // ç”ŸæˆæŠ¥å‘Šæ•°æ®
      function generateReportData() {
        const result = {
          totalQuestions: questions.length,
          correctCount: 0,
          incorrectCount: 0,
          totalTime: 0,
          totalHints: 0,
          questions: [],
        };

        questions.forEach((q, i) => {
          const ua = userAnswers[i];
          const correctAnswer = q.answer;
          const userAns = ua.answer;
          const isCorrect = userAns === correctAnswer;

          if (isCorrect) result.correctCount++;
          else result.incorrectCount++;

          result.totalTime += ua.accumulatedTime;
          result.totalHints += hintCounts[i] || 0;

          // è·å–ç­”æ¡ˆæ˜¾ç¤ºæ–‡æœ¬
          let userAnswerText = userAns || "æœªä½œç­”";
          let correctAnswerText = correctAnswer;

          if (q.type === "é€‰æ‹©é¢˜" && q.options) {
            if (userAns && q.options[userAns]) {
              userAnswerText = `${userAns}. ${q.options[userAns]}`;
            }
            if (q.options[correctAnswer]) {
              correctAnswerText = `${correctAnswer}. ${q.options[correctAnswer]}`;
            }
          } else if (q.type === "åˆ¤æ–­é¢˜") {
            userAnswerText =
              userAns === "å¯¹"
                ? "å¯¹ (æ­£ç¡®)"
                : userAns === "é”™"
                ? "é”™ (é”™è¯¯)"
                : "æœªä½œç­”";
            correctAnswerText =
              correctAnswer === "å¯¹" ? "å¯¹ (æ­£ç¡®)" : "é”™ (é”™è¯¯)";
          }

          result.questions.push({
            question: q.question,
            questionType: q.type,
            userAnswer: userAnswerText,
            correctAnswer: correctAnswerText,
            isCorrect: isCorrect,
            timeSpent: Math.floor(ua.accumulatedTime / 1000),
            hintCount: hintCounts[i] || 0,
            explanation: q.explanation || "",
          });
        });

        return result;
      }

      // æ˜¾ç¤ºæŠ¥å‘Š
      function showReport() {
        const reportData = generateReportData();
        if (!reportData) return;

        reportContainer.innerHTML = "";

        // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
        const accuracy = (
          (reportData.correctCount / reportData.totalQuestions) *
          100
        ).toFixed(1);
        const avgTime = Math.floor(
          reportData.totalTime / reportData.totalQuestions / 1000
        );

        const statsHtml = `
          <div class="report-stats">
            <div class="stat-item stat-correct">
              <div class="stat-value">${accuracy}%</div>
              <div class="stat-label">æ­£ç¡®ç‡</div>
            </div>
            <div class="stat-item stat-time">
              <div class="stat-value">${avgTime}ç§’</div>
              <div class="stat-label">å¹³å‡ç”¨æ—¶</div>
            </div>
            <div class="stat-item stat-hints">
              <div class="stat-value">${reportData.totalHints}</div>
              <div class="stat-label">æ€»æç¤ºæ¬¡æ•°</div>
            </div>
          </div>
        `;
        reportContainer.innerHTML = statsHtml;

        // æ·»åŠ æ¯é“é¢˜è¯¦æƒ…
        reportData.questions.forEach((q, index) => {
          const item = document.createElement("div");
          item.className = `report-item ${
            q.isCorrect ? "correct" : "incorrect"
          }`;

          item.innerHTML = `
            <div class="report-question">
              <span class="question-type-badge ${
                q.questionType === "é€‰æ‹©é¢˜"
                  ? "choice-question"
                  : q.questionType === "åˆ¤æ–­é¢˜"
                  ? "judgment-question"
                  : "short-answer-question"
              }">${q.questionType}</span>
              ${index + 1}. ${q.question}
            </div>
            <div class="report-answer">
              <div class="report-label">ä½ çš„ç­”æ¡ˆï¼š</div>
              <div class="report-value ${
                q.isCorrect ? "report-correct" : "report-incorrect"
              }">
                ${q.userAnswer}
              </div>
            </div>
            ${
              !q.isCorrect
                ? `
              <div class="report-answer">
                <div class="report-label">æ­£ç¡®ç­”æ¡ˆï¼š</div>
                <div class="report-value report-correct">${q.correctAnswer}</div>
              </div>
            `
                : ""
            }
            ${
              q.explanation
                ? `
              <div class="report-explanation">
                <div class="report-label">ğŸ“ é¢˜ç›®è§£æï¼š</div>
                <div class="report-explanation-text">${q.explanation}</div>
              </div>
            `
                : ""
            }
            <div class="report-detail">
              <div>â± ç”¨æ—¶: ${q.timeSpent}ç§’</div>
              <div>ğŸ’¡ æç¤º: ${q.hintCount}æ¬¡</div>
            </div>
          `;

          reportContainer.appendChild(item);
        });

        reportModal.style.display = "flex";
      }

      // æŸ¥çœ‹æŠ¥å‘ŠæŒ‰é’®äº‹ä»¶
      viewReportBtn.onclick = () => {
        showReport();
      };

      // å…³é—­æŠ¥å‘Šæ¨¡æ€æ¡†äº‹ä»¶
      closeModalBtn.onclick = () => {
        reportModal.style.display = "none";
      };

      // ç‚¹å‡»æŠ¥å‘Šæ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      reportModal.onclick = (event) => {
        if (event.target === reportModal) {
          reportModal.style.display = "none";
        }
      };

      // åˆå§‹åŒ–é¡µé¢
      async function init() {
        try {
          feedbackEl.textContent = "æ­£åœ¨åŠ è½½é¢˜ç›®...";
          feedbackEl.className = "success-feedback";

          const response = await fetch(apiUrl);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log(data);

          const rawQuestions = data.questions.exam || [];
          skill = data.skill;
          userId = data.user_id;

          if (rawQuestions.length === 0) {
            throw new Error("æ²¡æœ‰è·å–åˆ°é¢˜ç›®æ•°æ®");
          }

          questions = rawQuestions.map((q) => {
            let parsedOptions = {};

            if (q.question_type === "é€‰æ‹©é¢˜" && q.options) {
              try {
                parsedOptions = q.options;
              } catch (error) {
                console.warn("è§£æé€‰é¡¹å¤±è´¥:", error, q.options);
                parsedOptions = {};
              }
            }

            return {
              question_number: q.question_number,
              type: q.question_type,
              question: q.question_text,
              options: parsedOptions,
              answer: q.answer,
              explanation: q.explanation || "",
            };
          });

          userAnswers = questions.map(() => ({
            answer: null,
            accumulatedTime: 0,
            isTiming: false,
            lastStartTime: null,
          }));

          hintCounts = questions.map(() => 0);

          feedbackEl.textContent = "";
          feedbackEl.className = "";

          loadQuestion();
          startTiming();
          updateButtonStates();
        } catch (error) {
          console.error("åˆå§‹åŒ–å¤±è´¥:", error);
          feedbackEl.textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
          feedbackEl.className = "error-feedback";
        }
      }

      // åŠ è½½é¢˜ç›®
      function loadQuestion() {
        if (!questions.length || currentIndex >= questions.length) return;

        const q = questions[currentIndex];
        const userData = userAnswers[currentIndex];

        questionContainer.className = `font-mono ${
          q.type === "é€‰æ‹©é¢˜"
            ? "choice-question"
            : q.type === "åˆ¤æ–­é¢˜"
            ? "judgment-question"
            : q.type === "ç®€ç­”é¢˜" || q.type === "è¯æ˜é¢˜"
            ? "short-answer-question"
            : "choice-question"
        }`;

        const badge = questionContainer.querySelector(".question-type-badge");
        badge.textContent = q.type;

        questionText.textContent = q.question;
        questionNumberEl.textContent = `ç¬¬ ${currentIndex + 1} é¢˜ / å…± ${
          questions.length
        } é¢˜`;

        let optionsHtml = "";
        if (q.type === "é€‰æ‹©é¢˜") {
          optionsHtml = generateChoiceOptions(q.options, userData.answer);
        } else if (q.type === "åˆ¤æ–­é¢˜") {
          optionsHtml = generateJudgmentOptions(userData.answer);
        } else if (q.type === "ç®€ç­”é¢˜" || q.type === "è¯æ˜é¢˜") {
          optionsHtml = generateTextAnswerArea(userData.answer);
        }

        answerContainer.innerHTML = optionsHtml;

        // å¦‚æœå·²å®Œæˆæ£€æµ‹ï¼Œç¦ç”¨ç­”æ¡ˆè¾“å…¥
        if (isCompleted) {
          answerContainer.className = "disabled";
          if (q.type === "ç®€ç­”é¢˜" || q.type === "è¯æ˜é¢˜") {
            const textInput =
              answerContainer.querySelector(".text-answer-input");
            if (textInput) {
              textInput.disabled = true;
            }
          } else {
            answerContainer.querySelectorAll(".option-item").forEach((item) => {
              item.classList.add("disabled");
              item.onclick = null;
            });
          }
        }

        updateProgressBar();
        updateButtonStates();
      }

      // ç”Ÿæˆé€‰æ‹©é¢˜é€‰é¡¹
      function generateChoiceOptions(options, userAnswer) {
        let html = "";
        Object.entries(options).forEach(([key, value]) => {
          const isSelected = userAnswer === key;
          const disabledClass = isCompleted ? "disabled" : "";
          const onclickAttr = isCompleted
            ? ""
            : `onclick="selectOption('${key}')"`;

          html += `
            <div class="option-item ${
              isSelected ? "selected" : ""
            } ${disabledClass}" 
                 data-value="${key}" 
                 ${onclickAttr}>
              <div class="option-radio"></div>
              <div class="option-label">${key}</div>
              <div class="option-text">${value}</div>
            </div>
          `;
        });
        return html;
      }

      // ç”Ÿæˆåˆ¤æ–­é¢˜é€‰é¡¹
      function generateJudgmentOptions(userAnswer) {
        const options = [
          { key: "å¯¹", value: "æ­£ç¡®" },
          { key: "é”™", value: "é”™è¯¯" },
        ];

        let html = "";
        options.forEach((option) => {
          const isSelected = userAnswer === option.key;
          const disabledClass = isCompleted ? "disabled" : "";
          const onclickAttr = isCompleted
            ? ""
            : `onclick="selectOption('${option.key}')"`;

          html += `
            <div class="option-item ${
              isSelected ? "selected" : ""
            } ${disabledClass}" 
                 data-value="${option.key}" 
                 ${onclickAttr}>
              <div class="option-radio"></div>
              <div class="option-text">${option.value}</div>
            </div>
          `;
        });
        return html;
      }

      // ç”Ÿæˆæ–‡æœ¬ç­”æ¡ˆè¾“å…¥åŒºåŸŸ
      function generateTextAnswerArea(userAnswer) {
        const disabledAttr = isCompleted ? "disabled" : "";
        const onInputAttr = isCompleted
          ? ""
          : "oninput='handleTextAnswerInput(event)'";

        return `
          <div class="text-answer-container">
            <label class="text-answer-label">è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆï¼š</label>
            <textarea 
              class="text-answer-input" 
              placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„ç­”æ¡ˆ..." 
              ${disabledAttr}
              ${onInputAttr}
            >${userAnswer || ""}</textarea>
          </div>
        `;
      }

      // å¤„ç†æ–‡æœ¬ç­”æ¡ˆè¾“å…¥
      function handleTextAnswerInput(event) {
        if (isCompleted) return;

        const textValue = event.target.value;
        userAnswers[currentIndex].answer = textValue;
        updateButtonStates();
      }

      // é€‰æ‹©é€‰é¡¹
      function selectOption(value) {
        if (isCompleted) return;

        answerContainer.querySelectorAll(".option-item").forEach((item) => {
          item.classList.remove("selected");
        });

        const selectedItem = answerContainer.querySelector(
          `[data-value="${value}"]`
        );
        if (selectedItem) {
          selectedItem.classList.add("selected");
        }

        saveCurrentAnswer();
        updateButtonStates();
      }

      // ä¿å­˜å½“å‰ç­”æ¡ˆ
      function saveCurrentAnswer() {
        if (currentIndex >= userAnswers.length) return;

        const q = questions[currentIndex];
        const userData = userAnswers[currentIndex];

        if (q.type === "ç®€ç­”é¢˜" || q.type === "è¯æ˜é¢˜") {
          // å¯¹äºæ–‡æœ¬é¢˜ï¼Œç­”æ¡ˆå·²ç»åœ¨ handleTextAnswerInput ä¸­ä¿å­˜
          // è¿™é‡Œä¸éœ€è¦é¢å¤–å¤„ç†
        } else {
          // å¯¹äºé€‰æ‹©é¢˜å’Œåˆ¤æ–­é¢˜
          const selectedOption = answerContainer.querySelector(
            ".option-item.selected"
          );

          if (selectedOption) {
            userData.answer = selectedOption.dataset.value;
          }
        }

        if (userData.isTiming && userData.lastStartTime) {
          userData.accumulatedTime += Date.now() - userData.lastStartTime;
          userData.lastStartTime = Date.now();
        }
      }

      // å¼€å§‹è®¡æ—¶
      function startTiming() {
        if (isCompleted) return;

        const userData = userAnswers[currentIndex];

        if (!userData.accumulatedTime) userData.accumulatedTime = 0;

        userData.lastStartTime = Date.now();
        userData.isTiming = true;

        timerContainer.classList.add("running");

        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const currentTime =
            userData.accumulatedTime + (Date.now() - userData.lastStartTime);
          updateTimerDisplay(currentTime);
        }, 200);
      }

      // åœæ­¢è®¡æ—¶
      function stopTiming() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        const userData = userAnswers[currentIndex];
        if (userData && userData.isTiming && userData.lastStartTime) {
          userData.accumulatedTime += Date.now() - userData.lastStartTime;
          userData.lastStartTime = null;
          userData.isTiming = false;
        }

        timerContainer.classList.remove("running");
      }

      // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
      function updateTimerDisplay(milliseconds) {
        const seconds = Math.floor(milliseconds / 1000);
        timerEl.textContent = `${seconds}ç§’`;
      }

      // æ›´æ–°è¿›åº¦æ¡
      function updateProgressBar() {
        const answeredCount = userAnswers.filter(
          (a) => a.answer !== null && a.answer !== ""
        ).length;
        const progress = (answeredCount / questions.length) * 100;
        progressBar.style.width = `${progress}%`;
      }

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      function updateButtonStates() {
        if (isCompleted) {
          // å·²å®ŒæˆçŠ¶æ€
          prevBtn.disabled = false;
          nextBtn.disabled = false;
          submitBtn.style.display = "none";
          viewReportBtn.style.display = "inline-flex";

          // å°†æç¤ºæŒ‰é’®æ”¹ä¸ºæŸ¥çœ‹è¯Šæ–­ç»“æœæŒ‰é’®
          hintBtn.innerHTML = '<span class="btn-icon">ğŸ¯</span> æŸ¥çœ‹è¯Šæ–­ç»“æœ';
          hintBtn.disabled = false;

          // æ›´æ–°è®¡æ—¶å™¨çŠ¶æ€
          timerContainer.classList.remove("running");
          timerContainer.classList.add("submitted");
        } else {
          // æœªå®ŒæˆçŠ¶æ€
          prevBtn.disabled = currentIndex === 0;
          nextBtn.disabled = currentIndex === questions.length - 1;
          hintBtn.disabled = false;
          hintBtn.innerHTML = '<span class="btn-icon">ğŸ’¡</span> æŸ¥çœ‹æç¤º';

          const allAnswered = userAnswers.every(
            (a) => a.answer !== null && a.answer !== ""
          );

          if (allAnswered) {
            submitBtn.style.display = "inline-flex";
          } else {
            submitBtn.style.display = "none";
          }
          viewReportBtn.style.display = "none";
        }
      }

      // ä¸Šä¸€é¢˜
      prevBtn.onclick = () => {
        if (currentIndex > 0) {
          stopTiming();
          saveCurrentAnswer();
          currentIndex--;
          loadQuestion();
          if (!isCompleted) {
            startTiming();
          }
        }
      };

      // ä¸‹ä¸€é¢˜
      nextBtn.onclick = () => {
        if (currentIndex < questions.length - 1) {
          stopTiming();
          saveCurrentAnswer();
          currentIndex++;
          loadQuestion();
          if (!isCompleted) {
            startTiming();
          }
        }
      };

      // æäº¤æ£€æµ‹
      submitBtn.onclick = async () => {
        if (!confirm("ç¡®å®šè¦æäº¤æ£€æµ‹ç»“æœå—ï¼Ÿæäº¤åå°†æ— æ³•ä¿®æ”¹ã€‚")) {
          return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading-spinner"></span> æäº¤ä¸­...';

        try {
          stopTiming();
          saveCurrentAnswer();

          const submitData = {
            user_id: userId || 1,
            skill: skill,
            questions_detail: questions.map((q, index) => {
              const userAnswer = userAnswers[index];
              return {
                question_number: q.question_number,
                question_text: q.question,
                question_type: q.type,
                user_answer: userAnswer.answer || "æœªä½œç­”",
                correct_answer: q.answer,
                is_correct: userAnswer.answer === q.answer,
                time_spent: Math.floor(userAnswer.accumulatedTime / 1000),
                hint_count: hintCounts[index] || 0,
              };
            }),
            total_time: Math.floor((Date.now() - startTime) / 1000),
          };

          console.log("æäº¤æ•°æ®:", submitData);

          const response = await fetch(submitUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(submitData),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          // ä¿å­˜è¯Šæ–­ç»“æœ
          diagnosisResult = result.result || "è¯Šæ–­å®Œæˆï¼Œä½†æœªè·å–åˆ°è¯¦ç»†ç»“æœã€‚";

          // æ ‡è®°ä¸ºå·²å®Œæˆ
          isCompleted = true;

          // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
          showDiagnosisResult(diagnosisResult);
        } catch (error) {
          console.error("æäº¤å¤±è´¥:", error);
          feedbackEl.textContent = `æäº¤å¤±è´¥: ${error.message}`;
          feedbackEl.className = "error-feedback";

          submitBtn.disabled = false;
          submitBtn.innerHTML = '<span class="btn-icon">âœ“</span> å®Œæˆæ£€æµ‹';

          setTimeout(() => {
            feedbackEl.textContent = "";
            feedbackEl.className = "";
          }, 5000);
        }
      };

      // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
      function showDiagnosisResult(diagnosis) {
        diagnosisText.textContent = diagnosis;
        diagnosisModal.style.display = "flex";
      }

      // å…³é—­è¯Šæ–­ç»“æœå¼¹çª—
      function closeDiagnosisModal() {
        diagnosisModal.style.display = "none";

        // å¦‚æœæ˜¯åˆšå®Œæˆæ£€æµ‹ï¼Œæ›´æ–°ç•Œé¢çŠ¶æ€
        if (isCompleted) {
          // é‡æ–°åŠ è½½å½“å‰é¢˜ç›®ä»¥æ›´æ–°ç•Œé¢çŠ¶æ€
          loadQuestion();

          // æ˜¾ç¤ºæˆåŠŸæç¤º
          feedbackEl.textContent =
            "ğŸ‰ æ£€æµ‹å·²å®Œæˆï¼æ‚¨å¯ä»¥æŸ¥çœ‹åšé¢˜æƒ…å†µæŠ¥å‘Šæˆ–é‡æ–°æŸ¥çœ‹è¯Šæ–­ç»“æœã€‚";
          feedbackEl.className = "success-feedback";

          setTimeout(() => {
            feedbackEl.textContent = "";
            feedbackEl.className = "";
          }, 5000);
        }
      }

      // å¼¹çª—äº‹ä»¶ç»‘å®š
      closeDiagnosisBtn.onclick = closeDiagnosisModal;
      closeDiagnosis.onclick = closeDiagnosisModal;

      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      diagnosisModal.onclick = (event) => {
        if (event.target === diagnosisModal) {
          closeDiagnosisModal();
        }
      };

      // ESCé”®å…³é—­å¼¹çª—
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (diagnosisModal.style.display === "flex") {
            closeDiagnosisModal();
          }
          if (reportModal.style.display === "flex") {
            reportModal.style.display = "none";
          }
        }
      });

      // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤„ç†è®¡æ—¶
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          if (timerInterval && !isCompleted) {
            saveCurrentAnswer();
          }
        } else {
          if (
            questions.length > 0 &&
            currentIndex < questions.length &&
            !isCompleted
          ) {
            startTiming();
          }
        }
      });

      // åˆå§‹åŒ–åº”ç”¨
      init();

      // å¦‚æœquestionsé•¿åº¦ä¸º0ï¼Œåˆ™æ¯ç§’æ‰§è¡Œä¸€æ¬¡initå‡½æ•°
      let c = 0;
      let initInterval = null;
      setTimeout(() => {
        if (questions.length === 0) {
          initInterval = setInterval(() => {
            if (questions.length === 0) {
              init();
              c++;
            } else {
              clearInterval(initInterval);
              initInterval = null;
            }
            if (c > 3) {
              clearInterval(initInterval);
              initInterval = null;
              c = 0;
            }
          }, 1000);
        }
      }, 100);
    </script>
  </body>
</html>
