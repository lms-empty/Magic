<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ‹¾çº§è€Œä¸Šï¼Œè‡ªé€‚è€Œå­¦ - æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#3B82F6",
              secondary: "#10B981",
              accent: "#8B5CF6",
              deepseek: "#6366F1",
              aimodel: "#F97316",
              knowledge: "#4ADE80",
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="sidebar">
      <h2 class="font-display text-gradient">çŸ¥è¯†ç‚¹åˆ—è¡¨</h2>
      <div id="tabs"></div>
    </div>

    <div id="content">
      <div id="progress-bar-container">
        <div id="progress-bar"></div>
      </div>
      <!-- ä¿®æ”¹å†…å®¹åŒºåŸŸ tab åˆ‡æ¢ - å­¦ä¹ èµ„æºåœ¨å‰ -->
      <div class="content-tabs">
        <div class="content-tab active" data-tab="resource">å­¦ä¹ èµ„æº</div>
        <div class="content-tab" data-tab="question">é¢˜ç›®ç»ƒä¹ </div>
      </div>
      <div id="question-header">
        <div id="question-number" class="font-heading"></div>
        <div class="header-right">
          <div id="timer-container">
            <span class="timer-icon">â±</span>
            <span id="timer">0ç§’</span>
          </div>
          <!-- ä¿®æ”¹ï¼šæ›´æ¢èµ„æºæŒ‰é’®ï¼Œæ·»åŠ æ–‡å­—æè¿° -->
          <button
            id="change-resource-btn"
            class="change-resource-btn"
            style="display: none"
            title="æ›´æ¢å­¦ä¹ èµ„æº"
          >
            <span class="btn-icon">ğŸ”„</span>
            <span class="btn-text">æ›´æ¢èµ„æº</span>
          </button>
        </div>
      </div>

      <!-- å­¦ä¹ èµ„æºé¢æ¿ - é»˜è®¤æ¿€æ´» -->
      <div id="resource-panel" class="content-panel active">
        <div id="resource-container" class="resource-content">
          <!-- èµ„æºå¤´éƒ¨ -->
          <div class="resource-header">
            <div class="decoration-stars">
              <span class="star">âœ¨</span>
              <span class="star">â­</span>
              <span class="star">ğŸ’«</span>
              <span class="star">ğŸŒŸ</span>
            </div>
            <h3 id="resource-title">çŸ¥è¯†ç‚¹å­¦ä¹ èµ„æº</h3>
          </div>

          <!-- ç°ä»£åŒ–å­¦ä¹ å°åŠ©æ‰‹ -->
          <div class="learning-assistant">
            <div class="assistant-container">
              <div class="assistant-halo"></div>
              <div class="assistant-body">
                <div class="assistant-eyes">
                  <div class="eye"></div>
                  <div class="eye"></div>
                </div>
                <div class="assistant-mouth"></div>
                <div class="assistant-blush left"></div>
                <div class="assistant-blush right"></div>
              </div>
            </div>
            <div class="magic-particles">
              <div class="particle"></div>
              <div class="particle"></div>
              <div class="particle"></div>
              <div class="particle"></div>
            </div>
          </div>

          <!-- èµ„æºå†…å®¹åŒºåŸŸ -->
          <div id="resource-content">
            <!-- èµ„æºå†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
          </div>

          <!-- å¼€å§‹ç»ƒä¹ æŒ‰é’® -->
          <button id="start-practice-btn" class="blue-btn">
            <span class="btn-icon">ğŸ¯</span> å¼€å§‹é¢˜ç›®ç»ƒä¹ 
          </button>
        </div>
      </div>

      <!-- é¢˜ç›®ç»ƒä¹ é¢æ¿ -->
      <div id="question-panel" class="content-panel">
        <div id="question-container" class="font-mono">
          <div class="question-type-badge">é€‰æ‹©é¢˜</div>
          <div id="question-text"></div>
        </div>

        <div id="answer-container">
          <!-- é€‰é¡¹æˆ–åˆ¤æ–­é€‰æ‹©å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div id="feedback"></div>
      </div>

      <div class="button-group">
        <button id="hint-btn" class="blue-btn">
          <span class="btn-icon">ğŸ’¡</span> æŸ¥çœ‹æç¤º
        </button>
        <!-- æ–°å¢ï¼šå…¨éƒ¨å®Œæˆåçš„æ£€æµ‹æŒ‰é’® -->
        <button id="prev-btn" class="blue-btn">
          <span class="btn-icon">â—€</span> ä¸Šä¸€é¢˜
        </button>
        <button id="next-btn" class="blue-btn">
          <span class="btn-icon">â–¶</span> ä¸‹ä¸€é¢˜
        </button>
        <button id="submit-btn" class="blue-btn">
          <span class="btn-icon">âœ“</span> æäº¤æœ¬æ¨¡å—
        </button>
        <button id="view-report-btn" class="blue-btn">
          <span class="btn-icon">ğŸ“Š</span> æŸ¥çœ‹åšé¢˜æƒ…å†µ
        </button>
        <button id="complete-check-btn" class="blue-btn" style="display: none">
          <span class="btn-icon">ğŸ“</span>
          å­¦ä¹ ä»»åŠ¡éƒ½å®Œæˆå•¦ï¼Œæ¥æ£€æµ‹ä¸‹ä½ å¯¹è¿™ä¸ªçŸ¥è¯†ç‚¹çš„æŒæ¡æƒ…å†µå§ï½
        </button>
      </div>

      <!-- æŠ¥å‘Šæ¨¡æ€æ¡† -->
      <div id="report-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <span class="font-display text-gradient">åšé¢˜æƒ…å†µæŠ¥å‘Š</span>
            <span class="close-modal">&times;</span>
          </div>
          <div id="report-container"></div>
        </div>
      </div>

      <!-- æ›´æ¢å­¦ä¹ èµ„æºè¯¢é—®å¼¹çª— - ä¿®æ”¹ä¸ºèµ„æºç±»å‹é€‰æ‹© -->
      <div id="resource-change-modal" class="resource-change-modal">
        <div class="resource-change-content">
          <span class="resource-change-icon">ğŸ¯</span>
          <div class="resource-change-title">é€‰æ‹©å­¦ä¹ èµ„æºç±»å‹</div>
          <div class="resource-change-message">
            æ£€æµ‹å‘ç°æ‚¨åœ¨å½“å‰çŸ¥è¯†ç‚¹çš„æŒæ¡æƒ…å†µä¸º"<span
              id="mastery-status-text"
              class="mastery-status-highlight"
              >æœªæŒæ¡</span
            >"ã€‚<br />
            è¯·é€‰æ‹©æ‚¨å¸Œæœ›å­¦ä¹ çš„èµ„æºç±»å‹ï¼Œç³»ç»Ÿå°†ä¸ºæ‚¨æ¨èæ›´é€‚åˆçš„å­¦ä¹ èµ„æºï¼š
          </div>

          <!-- èµ„æºç±»å‹é€‰æ‹©åŒºåŸŸ -->
          <div class="resource-type-selection">
            <div class="resource-type-option" data-type="è§†é¢‘èµ„æº">
              <div class="resource-type-icon video-icon">ğŸ¥</div>
              <div class="resource-type-name">è§†é¢‘è¯¾ç¨‹</div>
              <div class="resource-type-desc">ç›´è§‚ç”ŸåŠ¨çš„è§†é¢‘è®²è§£</div>
            </div>

            <div class="resource-type-option" data-type="è®ºæ–‡èµ„æº">
              <div class="resource-type-icon paper-icon">ğŸ“„</div>
              <div class="resource-type-name">å­¦æœ¯è®ºæ–‡</div>
              <div class="resource-type-desc">æ·±å…¥çš„ç†è®ºç ”ç©¶èµ„æ–™</div>
            </div>

            <div class="resource-type-option" data-type="è¯¾ä»¶èµ„æº">
              <div class="resource-type-icon courseware-icon">ğŸ“Š</div>
              <div class="resource-type-name">æ•™å­¦è¯¾ä»¶</div>
              <div class="resource-type-desc">ç»“æ„åŒ–çš„çŸ¥è¯†å±•ç¤º</div>
            </div>

            <div class="resource-type-option" data-type="ç»ƒä¹ èµ„æº">
              <div class="resource-type-icon exercise-icon">ğŸ“</div>
              <div class="resource-type-name">ä¹ é¢˜ç»ƒä¹ </div>
              <div class="resource-type-desc">é’ˆå¯¹æ€§çš„ç»ƒä¹ é¢˜ç›®</div>
            </div>
          </div>

          <div class="resource-change-buttons">
            <button
              id="confirm-resource-type-btn"
              class="resource-change-btn btn-confirm"
              disabled
            >
              ç¡®è®¤é€‰æ‹©
            </button>
            <button
              id="cancel-change-btn"
              class="resource-change-btn btn-cancel"
            >
              æš‚ä¸æ›´æ¢
            </button>
          </div>
        </div>
      </div>

      <!-- å­¦ä¹ è·¯å¾„æ›´æ¢è¯¢é—®å¼¹çª— -->
      <div id="path-change-modal" class="path-change-modal">
        <div class="path-change-content">
          <span class="path-change-icon">ğŸ”„</span>
          <div class="path-change-title">å­¦ä¹ è·¯å¾„è°ƒæ•´å»ºè®®</div>
          <div class="path-change-message">
            æ£€æµ‹åˆ°æ‚¨åœ¨å½“å‰çŸ¥è¯†ç‚¹å·²å­¦ä¹ <span class="path-change-highlight"
              >è¶…è¿‡3æ¬¡</span
            >ï¼Œ<br />
            ä½†ä»ç„¶æœªèƒ½å¾ˆå¥½æŒæ¡ç›¸å…³å†…å®¹ã€‚<br />
            <br />
            ç³»ç»Ÿå»ºè®®ä¸ºæ‚¨è°ƒæ•´åç»­çš„å­¦ä¹ è·¯å¾„ï¼Œ<br />
            é‡‡ç”¨æ›´é€‚åˆæ‚¨å­¦ä¹ é£æ ¼çš„å†…å®¹å®‰æ’å’Œæ•™å­¦æ–¹å¼ã€‚
          </div>
          <div class="path-change-buttons">
            <button
              id="confirm-path-change-btn"
              class="path-change-btn btn-path-confirm"
            >
              æ˜¯ï¼Œè°ƒæ•´å­¦ä¹ è·¯å¾„
            </button>
            <button
              id="cancel-path-change-btn"
              class="path-change-btn btn-path-cancel"
            >
              ç»§ç»­å½“å‰è·¯å¾„
            </button>
          </div>
        </div>
      </div>

      <!-- æ–°å¢ï¼šè·¯å¾„é€‰æ‹©ç¡®è®¤å¼¹çª— -->
      <div id="path-selection-modal" class="path-selection-modal">
        <div class="path-selection-content">
          <span class="path-selection-icon">ğŸ¯</span>
          <div class="path-selection-title">æ™ºèƒ½å­¦ä¹ è·¯å¾„æ¨è</div>
          <div class="path-selection-message">
            åŸºäºæ‚¨çš„å­¦ä¹ æƒ…å†µï¼Œç³»ç»Ÿä¸ºæ‚¨æ¨èäº†æ–°çš„å­¦ä¹ è·¯å¾„ï¼š
          </div>

          <!-- è·¯å¾„å±•ç¤ºåŒºåŸŸ -->
          <div id="path-display" class="path-display">
            <!-- è·¯å¾„å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
          </div>

          <div class="path-selection-buttons">
            <button
              id="confirm-new-path-btn"
              class="path-selection-btn btn-path-accept"
            >
              é‡‡ç”¨æ–°è·¯å¾„
            </button>
            <button
              id="reject-new-path-btn"
              class="path-selection-btn btn-path-reject"
            >
              ç»§ç»­å½“å‰è·¯å¾„
            </button>
          </div>
        </div>
      </div>

      <!-- æ–°å¢ï¼šè¿”å›ä¸»é¡µæç¤ºå¼¹çª— -->
      <div id="return-home-modal" class="return-home-modal">
        <div class="return-home-content">
          <span class="return-home-icon">ğŸ </span>
          <div class="return-home-title">å­¦ä¹ è·¯å¾„å»ºè®®</div>
          <div class="return-home-message">
            çœ‹æ¥å½“å‰çš„å­¦ä¹ è·¯å¾„å¯èƒ½ä¸å¤ªé€‚åˆæ‚¨çš„å­¦ä¹ é£æ ¼ã€‚<br />
            å»ºè®®æ‚¨è¿”å›ä¸»é¡µï¼Œåœ¨å¯¹è¯æ¡†ä¸­è¯¦ç»†æè¿°æ‚¨çš„å­¦ä¹ éœ€æ±‚ï¼Œ<br />
            è®©ç³»ç»Ÿä¸ºæ‚¨é‡æ–°è§„åˆ’æ›´åˆé€‚çš„å­¦ä¹ è·¯å¾„ã€‚
          </div>
          <div class="return-home-buttons">
            <button id="go-home-btn" class="return-home-btn btn-home-confirm">
              è¿”å›ä¸»é¡µé‡æ–°è§„åˆ’
            </button>
            <button
              id="stay-current-btn"
              class="return-home-btn btn-home-cancel"
            >
              ç»§ç»­å½“å‰å­¦ä¹ 
            </button>
          </div>
        </div>
      </div>

      <!-- æ–°å¢ï¼šå­¦ä¹ å®Œæˆæé†’å¼¹çª— -->
      <div id="completion-reminder-modal" class="completion-reminder-modal">
        <div class="completion-reminder-content">
          <span class="completion-reminder-icon">ğŸ“</span>
          <div class="completion-reminder-title">å­¦ä¹ ä»»åŠ¡å®Œæˆï¼</div>
          <div class="completion-reminder-message">
            æ­å–œæ‚¨å®Œæˆäº†æœ¬æ¬¡å­¦ä¹ ï¼<br />
            ä½†æˆ‘ä»¬æ³¨æ„åˆ°æ‚¨åœ¨ä»¥ä¸‹çŸ¥è¯†ç‚¹çš„å­¦ä¹ è¿‡ç¨‹ä¸­éœ€è¦å¤šæ¬¡ç»ƒä¹ æ‰æŒæ¡ï¼š
          </div>

          <!-- é‡å¤å­¦ä¹ çŸ¥è¯†ç‚¹åˆ—è¡¨ -->
          <div id="repeated-knowledge-list" class="repeated-knowledge-list">
            <!-- åŠ¨æ€ç”Ÿæˆé‡å¤å­¦ä¹ çš„çŸ¥è¯†ç‚¹ -->
          </div>

          <div class="completion-reminder-suggestion">
            å»ºè®®æ‚¨åœ¨åç»­å­¦ä¹ ä¸­å¤šåŠ ç»ƒä¹ è¿™äº›çŸ¥è¯†ç‚¹ï¼Œ<br />
            æˆ–è€…å¯»æ‰¾æ›´å¤šç›¸å…³çš„ç»ƒä¹ é¢˜ç›®æ¥å·©å›ºæŒæ¡ã€‚
          </div>

          <div class="completion-reminder-buttons">
            <button
              id="understand-reminder-btn"
              class="completion-reminder-btn btn-understand"
            >
              æˆ‘çŸ¥é“äº†
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- å¿ƒæƒ…é¢æ¿ -->
    <div id="mood-panel" class="mood-panel">
      <div class="mood-panel-header">
        <span class="mood-panel-title">ä½ ç°åœ¨æ„Ÿè§‰å¦‚ä½•ï¼Ÿ</span>
        <button id="toggle-mood-panel" class="toggle-mood-panel">
          <span class="toggle-icon">â—€</span>
        </button>
      </div>
      <div class="mood-options">
        <label class="mood-option" data-mood="æ²®ä¸§">
          <input type="checkbox" value="æ²®ä¸§" />
          <div class="mood-content">
            <span class="mood-emoji">ğŸ˜</span>
            <span class="mood-label">æ²®ä¸§</span>
          </div>
        </label>
        <label class="mood-option" data-mood="å›°æƒ‘">
          <input type="checkbox" value="å›°æƒ‘" />
          <div class="mood-content">
            <span class="mood-emoji">ğŸ˜•</span>
            <span class="mood-label">å›°æƒ‘</span>
          </div>
        </label>
        <label class="mood-option" data-mood="ä¸“æ³¨">
          <input type="checkbox" value="ä¸“æ³¨" checked />
          <div class="mood-content">
            <span class="mood-emoji">ğŸ˜</span>
            <span class="mood-label">ä¸“æ³¨</span>
          </div>
        </label>
        <label class="mood-option" data-mood="æ— èŠ">
          <input type="checkbox" value="æ— èŠ" />
          <div class="mood-content">
            <span class="mood-emoji">ğŸ¥±</span>
            <span class="mood-label">æ— èŠ</span>
          </div>
        </label>
      </div>
      <div class="mood-auto-indicator">
        <span>ğŸ§  è‡ªåŠ¨æ£€æµ‹ä¸­...</span>
      </div>
    </div>

    <div id="mood-float-btn" class="mood-float-btn">
      <span class="mood-emoji">ğŸ˜Š</span>
      <span class="mood-text">å¿ƒæƒ…</span>
    </div>

    <script>
      // æ–°å¢ï¼šä»URLå‚æ•°è·å–roomIdçš„å‡½æ•°
      function getRoomIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("roomId");
      }

      // æ–°å¢ï¼šè·å–pathIdï¼Œä¼˜å…ˆä½¿ç”¨URLå‚æ•°ä¸­çš„roomIdï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼
      function getPathId() {
        const roomId = getRoomIdFromURL();
        if (roomId) {
          console.log("ä»URLè·å–åˆ°roomId:", roomId);
          return roomId;
        } else {
          console.log("æœªä»URLè·å–åˆ°roomIdï¼Œä½¿ç”¨é»˜è®¤å€¼: 212");
          return "212";
        }
      }

      // ä½¿ç”¨åŠ¨æ€è·å–çš„pathId
      const pathId = getPathId();
      console.log("å½“å‰ä½¿ç”¨çš„pathId:", pathId);

      const apiUrl = `http://172.20.192.249:3000/api/learning-paths/${pathId}/questions_and_resources`;
      const apiUrlUser = `http://172.20.192.249:3000/api/get-user-id/${pathId}`;
      const changeResourceUrl = `http://172.20.192.249:3000/api/learning-paths/${pathId}/change-resource-and-question`;
      // æ–°å¢ï¼šå­¦ä¹ è·¯å¾„æ›´æ¢APIæ¥å£
      const changePathUrl = `http://172.20.192.249:3000/api/learning-paths/${pathId}/change-learning-path`;
      // æ–°å¢ï¼šç¡®è®¤è·¯å¾„æ›´æ¢APIæ¥å£
      const confirmPathUrl = `http://172.20.192.249:3000/api/learning-paths/${pathId}/confirm-path-change`;

      const tabsEl = document.getElementById("tabs");
      const questionContainer = document.getElementById("question-container");
      const questionText = document.getElementById("question-text");
      const questionNumberEl = document.getElementById("question-number");
      const answerContainer = document.getElementById("answer-container");
      const feedbackEl = document.getElementById("feedback");
      const timerContainer = document.getElementById("timer-container");
      const timerEl = document.getElementById("timer");
      const progressBar = document.getElementById("progress-bar");

      const prevBtn = document.getElementById("prev-btn");
      const nextBtn = document.getElementById("next-btn");
      const submitBtn = document.getElementById("submit-btn");
      const viewReportBtn = document.getElementById("view-report-btn");
      const hintBtn = document.getElementById("hint-btn");
      const startPracticeBtn = document.getElementById("start-practice-btn");
      // æ–°å¢ï¼šæ›´æ¢èµ„æºæŒ‰é’®
      const changeResourceBtn = document.getElementById("change-resource-btn");
      // æ–°å¢ï¼šå®Œæˆæ£€æµ‹æŒ‰é’®
      const completeCheckBtn = document.getElementById("complete-check-btn");

      // è·å–æŠ¥å‘Šæ¨¡æ€æ¡†å…ƒç´ 
      const reportModal = document.getElementById("report-modal");
      const reportContainer = document.getElementById("report-container");
      const closeModal = document.querySelector(".close-modal");

      // è·å–æ›´æ¢èµ„æºå¼¹çª—å…ƒç´ 
      const resourceChangeModal = document.getElementById(
        "resource-change-modal"
      );
      const confirmResourceTypeBtn = document.getElementById(
        "confirm-resource-type-btn"
      );
      const cancelChangeBtn = document.getElementById("cancel-change-btn");
      const masteryStatusText = document.getElementById("mastery-status-text");

      // è·å–å­¦ä¹ è·¯å¾„æ›´æ¢å¼¹çª—å…ƒç´ 
      const pathChangeModal = document.getElementById("path-change-modal");
      const confirmPathChangeBtn = document.getElementById(
        "confirm-path-change-btn"
      );
      const cancelPathChangeBtn = document.getElementById(
        "cancel-path-change-btn"
      );

      // æ–°å¢ï¼šè·å–è·¯å¾„é€‰æ‹©å¼¹çª—å…ƒç´ 
      const pathSelectionModal = document.getElementById(
        "path-selection-modal"
      );
      const pathDisplay = document.getElementById("path-display");
      const confirmNewPathBtn = document.getElementById("confirm-new-path-btn");
      const rejectNewPathBtn = document.getElementById("reject-new-path-btn");

      // æ–°å¢ï¼šè·å–è¿”å›ä¸»é¡µå¼¹çª—å…ƒç´ 
      const returnHomeModal = document.getElementById("return-home-modal");
      const goHomeBtn = document.getElementById("go-home-btn");
      const stayCurrentBtn = document.getElementById("stay-current-btn");

      // æ–°å¢ï¼šè·å–å­¦ä¹ å®Œæˆæé†’å¼¹çª—å…ƒç´ 
      const completionReminderModal = document.getElementById(
        "completion-reminder-modal"
      );
      const repeatedKnowledgeList = document.getElementById(
        "repeated-knowledge-list"
      );
      const understandReminderBtn = document.getElementById(
        "understand-reminder-btn"
      );

      // å…¨å±€çŠ¶æ€ç®¡ç†
      let submittedTabs = {};
      let unlockedTabs = {};
      let hintCounts = {};
      let rawData = [];
      let knowledgePoints = {};
      let keys = [];
      let currentTab = null;
      let currentIndex = 0;
      let currentTabIndex = 0;
      let timerInterval = null;
      let userAnswers = {};
      let tabReports = {}; // å­˜å‚¨æ¯ä¸ªæ ‡ç­¾é¡µçš„æŠ¥å‘Šæ•°æ®
      let user_id = 0;
      let selectedResourceType = null; // ç”¨æˆ·é€‰æ‹©çš„èµ„æºç±»å‹
      let pathChangeData = null; // å­˜å‚¨è·¯å¾„æ›´æ¢æ•°æ®
      let isFromPathRejection = false; // æ ‡è®°æ˜¯å¦æ¥è‡ªè·¯å¾„æ‹’ç»

      // æ–°å¢ï¼šå…¨å±€çŠ¶æ€æ ‡è®°
      let hasShownCompletionReminder = false; // æ˜¯å¦å·²æ˜¾ç¤ºè¿‡å®Œæˆæé†’å¼¹çª—
      let isAllTasksCompleted = false; // æ˜¯å¦å…¨éƒ¨ä»»åŠ¡å·²å®Œæˆ

      // åœ¨å…¨å±€å˜é‡åŒºåŸŸæ·»åŠ å¿ƒæƒ…é¢æ¿ç›¸å…³å˜é‡
      let moodPanelHidden = false;
      let moodAutoUpdateEnabled = true;
      let moodPanelDragged = false;
      let moodPanelDragOffset = { x: 0, y: 0 };

      // åœ¨ DOMContentLoaded äº‹ä»¶ä¸­æ·»åŠ å¿ƒæƒ…é¢æ¿äº‹ä»¶å¤„ç†
      // åœ¨ DOMContentLoaded äº‹ä»¶ä¸­æ·»åŠ å¿ƒæƒ…é¢æ¿äº‹ä»¶å¤„ç†
      document.addEventListener("DOMContentLoaded", function () {
        // å¿ƒæƒ…é¢æ¿åˆ‡æ¢æŒ‰é’®äº‹ä»¶
        const toggleMoodPanelBtn = document.getElementById("toggle-mood-panel");
        const moodPanel = document.getElementById("mood-panel");
        const moodFloatBtn = document.getElementById("mood-float-btn");
        const toggleIcon = toggleMoodPanelBtn.querySelector(".toggle-icon");

        // åˆå§‹åŒ–çŠ¶æ€
        let moodPanelHidden = false;
        moodFloatBtn.style.display = "none";
        toggleMoodPanelBtn.addEventListener("click", function () {
          moodPanelHidden = !moodPanelHidden;

          if (moodPanelHidden) {
            moodPanel.classList.add("hidden");
            moodFloatBtn.style.display = "flex";
            toggleIcon.textContent = "â–¶";
            toggleIcon.style.transform = "rotate(180deg)";
          } else {
            moodPanel.classList.remove("hidden");
            moodFloatBtn.style.display = "none";
            toggleIcon.textContent = "â—€";
            toggleIcon.style.transform = "rotate(0deg)";
          }
        });

        // æ‚¬æµ®æŒ‰é’®äº‹ä»¶
        moodFloatBtn.addEventListener("click", function () {
          moodPanelHidden = false;
          moodPanel.classList.remove("hidden");
          moodFloatBtn.style.display = "none";
          toggleIcon.textContent = "â—€";
          toggleIcon.style.transform = "rotate(0deg)";
        });

        // å¿ƒæƒ…é€‰é¡¹ç‚¹å‡»åé¦ˆ
        const moodOptions = document.querySelectorAll(".mood-option");
        moodOptions.forEach((option) => {
          option.addEventListener("click", function (e) {
            // é˜²æ­¢äº‹ä»¶å†’æ³¡
            if (e.target.tagName === "INPUT") return;

            const checkbox = this.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;

            // è§¦å‘changeäº‹ä»¶
            checkbox.dispatchEvent(new Event("change"));
          });
        });
      });

      // å¿ƒæƒ…é¢æ¿æ‹–æ‹½å¼€å§‹
      function startMoodPanelDrag(e) {
        if (e.target.closest(".toggle-btn") || e.target.closest("input"))
          return;

        moodPanelDragged = true;
        const moodPanel = document.getElementById("mood-panel");
        const rect = moodPanel.getBoundingClientRect();

        moodPanelDragOffset = {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top,
        };

        document.addEventListener("mousemove", dragMoodPanel);
        document.addEventListener("mouseup", stopMoodPanelDrag);
      }

      // æ‚¬æµ®æŒ‰é’®æ‹–æ‹½å¼€å§‹
      function startMoodFloatBtnDrag(e) {
        moodPanelDragged = true;
        const moodFloatBtn = document.getElementById("mood-float-btn");
        const rect = moodFloatBtn.getBoundingClientRect();

        moodPanelDragOffset = {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top,
        };

        document.addEventListener("mousemove", dragMoodFloatBtn);
        document.addEventListener("mouseup", stopMoodFloatBtnDrag);
      }

      // æ‹–æ‹½å¿ƒæƒ…é¢æ¿
      function dragMoodPanel(e) {
        if (!moodPanelDragged) return;

        const moodPanel = document.getElementById("mood-panel");
        moodPanel.style.right = "auto";
        moodPanel.style.left = e.clientX - moodPanelDragOffset.x + "px";
        moodPanel.style.top = e.clientY - moodPanelDragOffset.y + "px";
      }

      // åœæ­¢æ‹–æ‹½å¿ƒæƒ…é¢æ¿
      function stopMoodPanelDrag() {
        moodPanelDragged = false;
        document.removeEventListener("mousemove", dragMoodPanel);
        document.removeEventListener("mouseup", stopMoodPanelDrag);
      }

      // æ‹–æ‹½æ‚¬æµ®æŒ‰é’®
      function dragMoodFloatBtn(e) {
        if (!moodPanelDragged) return;

        const moodFloatBtn = document.getElementById("mood-float-btn");
        moodFloatBtn.style.right = "auto";
        moodFloatBtn.style.left = e.clientX - moodPanelDragOffset.x + "px";
        moodFloatBtn.style.top = e.clientY - moodPanelDragOffset.y + "px";
      }

      // åœæ­¢æ‹–æ‹½æ‚¬æµ®æŒ‰é’®
      function stopMoodFloatBtnDrag() {
        moodPanelDragged = false;
        document.removeEventListener("mousemove", dragMoodFloatBtn);
        document.removeEventListener("mouseup", stopMoodFloatBtnDrag);
      }

      // åœ¨å…¨å±€çŠ¶æ€ç®¡ç†åŒºåŸŸæ·»åŠ å¿ƒæƒ…ç›¸å…³å˜é‡
      let userMoods = {}; // å­˜å‚¨ç”¨æˆ·å¿ƒæƒ…çŠ¶æ€
      // æ–°å¢ï¼šå®Œæˆæ£€æµ‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      completeCheckBtn.onclick = () => {
        // è·³è½¬åˆ°è®¤çŸ¥è¯Šæ–­é¡µé¢

        window.location.href = "http://127.0.0.1:5500/cognitive_diagnosis.html";
      };

      // æŸ¥çœ‹æç¤ºåŠŸèƒ½ - ä¿®æ”¹ä¸ºæ”¯æŒç³»ç»Ÿæé†’æ¨¡å¼
      hintBtn.onclick = () => {
        // å¦‚æœæŒ‰é’®å·²ç»åˆ‡æ¢ä¸º"æŸ¥çœ‹ç³»ç»Ÿæé†’"æ¨¡å¼ï¼Œç›´æ¥æ˜¾ç¤ºç³»ç»Ÿæé†’
        if (hintBtn.classList.contains("system-reminder-mode")) {
          // é‡æ–°æ˜¾ç¤ºå®Œæˆæé†’å¼¹çª—y
          showCompletionReminderModal();
          return;
        }

        // åŸæœ‰çš„æŸ¥çœ‹æç¤ºåŠŸèƒ½éœ€è¦æ£€æŸ¥çŸ¥è¯†ç‚¹çŠ¶æ€
        if (!currentTab || submittedTabs[currentTab]) return;

        // åŸæœ‰çš„æŸ¥çœ‹æç¤ºåŠŸèƒ½
        hintCounts[currentTab][currentIndex] =
          (hintCounts[currentTab][currentIndex] || 0) + 1;
        feedbackEl.textContent =
          "ğŸ’¡ æç¤ºï¼šè¯·æ³¨æ„é¢˜ç›®ä¸­çš„å…³é”®è¯ï¼Œè®¤çœŸåˆ†æè§£é¢˜æ€è·¯ï¼";
        feedbackEl.className = "success-feedback";

        setTimeout(() => {
          feedbackEl.textContent = "";
          feedbackEl.className = "";
        }, 4000);
      };

      // å¼€å§‹ç»ƒä¹ æŒ‰é’®äº‹ä»¶
      startPracticeBtn.onclick = () => {
        // åˆ‡æ¢åˆ°é¢˜ç›®ç»ƒä¹ é¢æ¿
        document.querySelector('.content-tab[data-tab="question"]').click();
      };

      // æ–°å¢ï¼šæ›´æ¢èµ„æºæŒ‰é’®äº‹ä»¶
      changeResourceBtn.onclick = () => {
        showResourceChangeModal();
      };

      // æ›´æ¢å­¦ä¹ èµ„æºç›¸å…³å‡½æ•° - ä¿®æ”¹ä¸ºæ¥å—æŒæ¡çŠ¶æ€å‚æ•°
      function showResourceChangeModal(masteryStatus = "æœªæŒæ¡") {
        console.log("æ˜¾ç¤ºæ›´æ¢èµ„æºå¼¹çª—ï¼ŒæŒæ¡çŠ¶æ€:", masteryStatus); // è°ƒè¯•ä¿¡æ¯
        selectedResourceType = null; // é‡ç½®é€‰æ‹©

        // æ›´æ–°æŒæ¡çŠ¶æ€æ˜¾ç¤º
        masteryStatusText.textContent = masteryStatus;

        // é‡ç½®æ‰€æœ‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll(".resource-type-option").forEach((option) => {
          option.classList.remove("selected");
        });

        // ç¦ç”¨ç¡®è®¤æŒ‰é’®
        confirmResourceTypeBtn.disabled = true;
        confirmResourceTypeBtn.classList.add("disabled");

        resourceChangeModal.style.display = "flex";
        resourceChangeModal.style.visibility = "visible";
        resourceChangeModal.style.opacity = "1";
        // å¼ºåˆ¶è§¦å‘é‡æ–°æ¸²æŸ“
        resourceChangeModal.offsetHeight;
      }

      function hideResourceChangeModal() {
        console.log("éšè—æ›´æ¢èµ„æºå¼¹çª—"); // è°ƒè¯•ä¿¡æ¯
        resourceChangeModal.style.display = "none";
        resourceChangeModal.style.visibility = "hidden";
        resourceChangeModal.style.opacity = "0";
        selectedResourceType = null;
      }

      // æ–°å¢ï¼šæ˜¾ç¤ºæ›´æ¢èµ„æºæŒ‰é’®
      function showChangeResourceButton() {
        console.log("æ˜¾ç¤ºæ›´æ¢èµ„æºæŒ‰é’®");
        changeResourceBtn.style.display = "flex";
      }

      // æ–°å¢ï¼šéšè—æ›´æ¢èµ„æºæŒ‰é’®
      function hideChangeResourceButton() {
        console.log("éšè—æ›´æ¢èµ„æºæŒ‰é’®");
        changeResourceBtn.style.display = "none";
      }

      // èµ„æºç±»å‹é€‰æ‹©äº‹ä»¶å¤„ç†
      document.addEventListener("DOMContentLoaded", function () {
        const resourceTypeOptions = document.querySelectorAll(
          ".resource-type-option"
        );

        resourceTypeOptions.forEach((option) => {
          option.addEventListener("click", function () {
            // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            resourceTypeOptions.forEach((opt) =>
              opt.classList.remove("selected")
            );

            // é€‰ä¸­å½“å‰é€‰é¡¹
            this.classList.add("selected");

            // ä¿å­˜é€‰æ‹©çš„èµ„æºç±»å‹
            selectedResourceType = this.getAttribute("data-type");

            // å¯ç”¨ç¡®è®¤æŒ‰é’®
            confirmResourceTypeBtn.disabled = false;
            confirmResourceTypeBtn.classList.remove("disabled");

            console.log("é€‰æ‹©çš„èµ„æºç±»å‹:", selectedResourceType);
          });
        });
      });

      // å­¦ä¹ è·¯å¾„æ›´æ¢ç›¸å…³å‡½æ•°
      function showPathChangeModal() {
        console.log("æ˜¾ç¤ºå­¦ä¹ è·¯å¾„æ›´æ¢å¼¹çª—"); // è°ƒè¯•ä¿¡æ¯
        pathChangeModal.style.display = "flex";
        pathChangeModal.style.visibility = "visible";
        pathChangeModal.style.opacity = "1";
        // å¼ºåˆ¶è§¦å‘é‡æ–°æ¸²æŸ“
        pathChangeModal.offsetHeight;
      }

      function hidePathChangeModal() {
        console.log("éšè—å­¦ä¹ è·¯å¾„æ›´æ¢å¼¹çª—"); // è°ƒè¯•ä¿¡æ¯
        pathChangeModal.style.display = "none";
        pathChangeModal.style.visibility = "hidden";
        pathChangeModal.style.opacity = "0";
      }

      // ä¿®å¤è·¯å¾„é€‰æ‹©å¼¹çª—ç›¸å…³å‡½æ•° - ä¸»è¦ä¿®å¤ç‚¹
      function showPathSelectionModal(pathData) {
        console.log("æ˜¾ç¤ºè·¯å¾„é€‰æ‹©å¼¹çª—ï¼Œæ•°æ®:", pathData); // è°ƒè¯•ä¿¡æ¯
        pathChangeData = pathData; // ä¿å­˜è·¯å¾„æ•°æ®

        // é¦–å…ˆéšè—æ‰€æœ‰å…¶ä»–å¼¹çª—
        hidePathChangeModal();
        hideResourceChangeModal();
        hideReturnHomeModal();
        hideCompletionReminderModal();

        // ç”Ÿæˆè·¯å¾„å±•ç¤ºå†…å®¹
        const finalPlan = pathData.python_output?.final_plan || [];
        console.log("è·¯å¾„è®¡åˆ’:", finalPlan); // è°ƒè¯•ä¿¡æ¯

        let pathHtml = '<div class="path-list">';

        if (finalPlan.length > 0) {
          finalPlan.forEach((item, index) => {
            pathHtml += `
              <div class="path-item">
                <div class="path-number">${index + 1}</div>
                <div class="path-content">${item}</div>
              </div>
            `;
          });
        } else {
          pathHtml +=
            '<div class="path-item"><div class="path-content">æš‚æ— å…·ä½“è·¯å¾„è§„åˆ’</div></div>';
        }

        pathHtml += "</div>";
        pathDisplay.innerHTML = pathHtml;

        // å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„æ˜¾ç¤ºæ–¹æ³•
        console.log("å‡†å¤‡æ˜¾ç¤ºè·¯å¾„é€‰æ‹©å¼¹çª—");

        // ç¡®ä¿å…ƒç´ å®Œå…¨éšè—çŠ¶æ€ï¼Œç„¶åå†æ˜¾ç¤º
        pathSelectionModal.style.display = "none";
        pathSelectionModal.style.visibility = "hidden";
        pathSelectionModal.style.opacity = "0";

        // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿æ ·å¼æ›´æ–°å®Œæˆåå†æ˜¾ç¤º
        requestAnimationFrame(() => {
          pathSelectionModal.style.display = "flex";
          pathSelectionModal.style.visibility = "visible";
          pathSelectionModal.style.opacity = "1";
          pathSelectionModal.style.zIndex = "2000"; // è®¾ç½®æ›´é«˜çš„z-indexç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚

          // å¼ºåˆ¶è§¦å‘é‡æ–°æ¸²æŸ“
          pathSelectionModal.offsetHeight;

          console.log("è·¯å¾„é€‰æ‹©å¼¹çª—æ˜¾ç¤ºçŠ¶æ€:", {
            display: pathSelectionModal.style.display,
            visibility: pathSelectionModal.style.visibility,
            opacity: pathSelectionModal.style.opacity,
            zIndex: pathSelectionModal.style.zIndex,
          });
        });
      }

      function hidePathSelectionModal() {
        console.log("éšè—è·¯å¾„é€‰æ‹©å¼¹çª—"); // è°ƒè¯•ä¿¡æ¯
        pathSelectionModal.style.display = "none";
        pathSelectionModal.style.visibility = "hidden";
        pathSelectionModal.style.opacity = "0";
        pathSelectionModal.style.zIndex = "1500"; // æ¢å¤åŸå§‹z-index
        pathChangeData = null;
      }

      // æ–°å¢ï¼šè¿”å›ä¸»é¡µå¼¹çª—ç›¸å…³å‡½æ•°
      function showReturnHomeModal() {
        console.log("æ˜¾ç¤ºè¿”å›ä¸»é¡µå¼¹çª—"); // è°ƒè¯•ä¿¡æ¯
        // ç¡®ä¿éšè—å…¶ä»–å¼¹çª—
        hidePathSelectionModal();
        hidePathChangeModal();
        hideResourceChangeModal();
        hideCompletionReminderModal();

        setTimeout(() => {
          returnHomeModal.style.display = "flex";
          returnHomeModal.style.visibility = "visible";
          returnHomeModal.style.opacity = "1";
          returnHomeModal.offsetHeight;
        }, 100);
      }

      function hideReturnHomeModal() {
        console.log("éšè—è¿”å›ä¸»é¡µå¼¹çª—"); // è°ƒè¯•ä¿¡æ¯
        returnHomeModal.style.display = "none";
        returnHomeModal.style.visibility = "hidden";
        returnHomeModal.style.opacity = "0";
      }

      // æ–°å¢ï¼šå­¦ä¹ å®Œæˆæé†’å¼¹çª—ç›¸å…³å‡½æ•°
      function showCompletionReminderModal() {
        console.log("æ˜¾ç¤ºå­¦ä¹ å®Œæˆæé†’å¼¹çª—");

        // è·å–æ‰€æœ‰é‡å¤å­¦ä¹ è¶…è¿‡3æ¬¡çš„çŸ¥è¯†ç‚¹
        const repeatedKnowledgePoints = getRepeatedKnowledgePoints();

        if (repeatedKnowledgePoints.length === 0) {
          console.log("æ²¡æœ‰é‡å¤å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œä¸æ˜¾ç¤ºæé†’");
          return;
        }

        // ç¡®ä¿éšè—å…¶ä»–å¼¹çª—
        hidePathSelectionModal();
        hidePathChangeModal();
        hideResourceChangeModal();
        hideReturnHomeModal();

        // ç«‹å³æ ‡è®°å·²æ˜¾ç¤ºè¿‡å®Œæˆæé†’ï¼Œå¹¶æ›´æ–°æŒ‰é’®çŠ¶æ€
        hasShownCompletionReminder = true;
        updateHintButtonState();

        // ç”Ÿæˆé‡å¤å­¦ä¹ çŸ¥è¯†ç‚¹åˆ—è¡¨
        let listHtml = '<div class="repeated-knowledge-items">';
        repeatedKnowledgePoints.forEach((item, index) => {
          listHtml += `
            <div class="repeated-knowledge-item">
              <span class="knowledge-name">${item.knowledgePoint}</span>
              <span class="learning-count">å­¦ä¹ ${item.learningCount}æ¬¡åæŒæ¡</span>
            </div>
          `;
        });
        listHtml += "</div>";

        repeatedKnowledgeList.innerHTML = listHtml;

        setTimeout(() => {
          completionReminderModal.style.display = "flex";
          completionReminderModal.style.visibility = "visible";
          completionReminderModal.style.opacity = "1";
          completionReminderModal.offsetHeight;
        }, 100);
      }

      function hideCompletionReminderModal() {
        console.log("éšè—å­¦ä¹ å®Œæˆæé†’å¼¹çª—");
        completionReminderModal.style.display = "none";
        completionReminderModal.style.visibility = "hidden";
        completionReminderModal.style.opacity = "0";
      }

      // æ–°å¢ï¼šè·å–é‡å¤å­¦ä¹ è¶…è¿‡3æ¬¡çš„çŸ¥è¯†ç‚¹
      function getRepeatedKnowledgePoints() {
        const repeatedPoints = [];

        Object.keys(tabReports).forEach((knowledgePoint) => {
          const report = tabReports[knowledgePoint];
          if (
            report &&
            report.learningCount > 3 &&
            report.masteryResult !== "æœªæŒæ¡"
          ) {
            repeatedPoints.push({
              knowledgePoint: knowledgePoint,
              learningCount: report.learningCount,
            });
          }
        });

        return repeatedPoints;
      }

      // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æ‰€æœ‰çŸ¥è¯†ç‚¹éƒ½å·²å®Œæˆ
      function checkAllKnowledgePointsCompleted() {
        const completedCount = Object.keys(submittedTabs).filter(
          (key) => submittedTabs[key]
        ).length;
        const totalCount = keys.length;

        console.log(`å·²å®ŒæˆçŸ¥è¯†ç‚¹: ${completedCount}/${totalCount}`);

        if (completedCount === totalCount && totalCount > 0) {
          // æ ‡è®°å…¨éƒ¨ä»»åŠ¡å·²å®Œæˆ
          isAllTasksCompleted = true;

          // æ˜¾ç¤ºå®Œæˆæ£€æµ‹æŒ‰é’®
          updateCompleteCheckButtonVisibility();

          // å»¶è¿Ÿæ˜¾ç¤ºå®Œæˆæé†’ï¼Œè®©ç”¨æˆ·å…ˆçœ‹åˆ°æäº¤æˆåŠŸçš„åé¦ˆ
          setTimeout(() => {
            showCompletionReminderModal();
          }, 3000);
        }
      }

      // æ–°å¢ï¼šæ›´æ–°å®Œæˆæ£€æµ‹æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
      function updateCompleteCheckButtonVisibility() {
        if (isAllTasksCompleted) {
          completeCheckBtn.style.display = "inline-flex";
        } else {
          completeCheckBtn.style.display = "none";
        }
      }

      // æ–°å¢ï¼šæ›´æ–°æŸ¥çœ‹æç¤ºæŒ‰é’®çŠ¶æ€
      function updateHintButtonState() {
        if (hasShownCompletionReminder) {
          // åˆ‡æ¢ä¸ºç³»ç»Ÿæé†’æ¨¡å¼
          hintBtn.innerHTML = '<span class="btn-icon">ğŸ””</span> æŸ¥çœ‹ç³»ç»Ÿæé†’';
          hintBtn.classList.add("system-reminder-mode");
          hintBtn.title = "æŸ¥çœ‹ç³»ç»Ÿå­¦ä¹ æé†’";
          hintBtn.disabled = false; // ç³»ç»Ÿæé†’æ¨¡å¼ä¸‹å§‹ç»ˆå¯ç”¨
        } else {
          // ä¿æŒåŸæœ‰çš„æŸ¥çœ‹æç¤ºæ¨¡å¼
          hintBtn.innerHTML = '<span class="btn-icon">ğŸ’¡</span> æŸ¥çœ‹æç¤º';
          hintBtn.classList.remove("system-reminder-mode");
          hintBtn.title = "æŸ¥çœ‹ç­”é¢˜æç¤º";
          // æ™®é€šæç¤ºæ¨¡å¼ä¸‹çš„disabledçŠ¶æ€åœ¨updateButtonStatesä¸­å¤„ç†
        }
      }

      // æ›´æ¢å­¦ä¹ èµ„æºAPIè°ƒç”¨ - ä¿®æ”¹ä¸ºåŒ…å«èµ„æºç±»å‹
      async function changeResourceAPI(knowledgePoint, resourceType) {
        console.log(currentTabIndex);

        try {
          const response = await fetch(changeResourceUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              id: rawData[currentTabIndex].id,
              path_id: pathId,
              user_id: user_id,
              knowledge_point: knowledgePoint,
              resource_type: resourceType, // æ–°å¢èµ„æºç±»å‹å‚æ•°
              reason: `ç”¨æˆ·é€‰æ‹©${resourceType}ç±»å‹çš„å­¦ä¹ èµ„æºï¼Œä»¥æé«˜å­¦ä¹ æ•ˆæœ`,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log("æ›´æ¢èµ„æºæˆåŠŸ:", result);
          return { success: true, data: result };
        } catch (error) {
          console.error("æ›´æ¢èµ„æºå¤±è´¥:", error);
          return { success: false, error: error.message };
        }
      }

      // æ›´æ¢å­¦ä¹ è·¯å¾„APIè°ƒç”¨ - ä¿®æ”¹ä¸ºå¤„ç†æ–°çš„è¿”å›æ ¼å¼
      async function changePathAPI(knowledgePoint, learningCount) {
        console.log("è°ƒç”¨å­¦ä¹ è·¯å¾„æ›´æ¢API:", {
          knowledgePoint,
          learningCount,
          currentTabIndex,
        });

        try {
          const response = await fetch(changePathUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              id: rawData[currentTabIndex].id,
              skill_id: rawData[currentTabIndex].skill_id,
              path_id: pathId,
              user_id: user_id,
              knowledge_point: knowledgePoint,
              learning_count: learningCount,
              current_performance: "å¤šæ¬¡å­¦ä¹ æœªæŒæ¡",
              reason: `å­¦ä¹ æ¬¡æ•°å·²è¾¾${learningCount}æ¬¡ï¼Œå»ºè®®è°ƒæ•´å­¦ä¹ è·¯å¾„ä»¥æé«˜å­¦ä¹ æ•ˆæœ`,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log("æ›´æ¢å­¦ä¹ è·¯å¾„APIè¿”å›:", result);
          return { success: true, data: result };
        } catch (error) {
          console.error("æ›´æ¢å­¦ä¹ è·¯å¾„å¤±è´¥:", error);
          return { success: false, error: error.message };
        }
      }

      // æ–°å¢ï¼šç¡®è®¤è·¯å¾„æ›´æ¢APIè°ƒç”¨
      async function confirmPathChangeAPI(pythonOutput) {
        console.log("è°ƒç”¨ç¡®è®¤è·¯å¾„æ›´æ¢API:", pythonOutput);

        try {
          const response = await fetch(confirmPathUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              path_id: pathId,
              user_id: user_id,
              python_output: pythonOutput,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log("ç¡®è®¤è·¯å¾„æ›´æ¢æˆåŠŸ:", result);
          return { success: true, data: result };
        } catch (error) {
          console.error("ç¡®è®¤è·¯å¾„æ›´æ¢å¤±è´¥:", error);
          return { success: false, error: error.message };
        }
      }

      // ä¿®å¤é‡å¤çŸ¥è¯†ç‚¹é—®é¢˜çš„æ›´æ–°å­¦ä¹ è·¯å¾„å‡½æ•°
      async function updateLearningPath() {
        try {
          console.log("å¼€å§‹æ›´æ–°å­¦ä¹ è·¯å¾„æ•°æ®ï¼Œå½“å‰çŸ¥è¯†ç‚¹:", currentTab);
          console.log("æ›´æ–°å‰çš„åŸå§‹keys:", [...keys]);

          // é‡æ–°è·å–æ•°æ®
          const res = await fetch(apiUrl);
          const newRawData = await res.json();
          console.log("è·å–åˆ°æ–°çš„åŸå§‹æ•°æ®:", newRawData);

          // è§£ææ–°æ•°æ®
          const newKnowledgePoints = {};
          newRawData.forEach((item) => {
            const parsed = safeParseQuestions(item.questions);
            Object.entries(parsed).forEach(([k, v]) => {
              if (!newKnowledgePoints[k]) newKnowledgePoints[k] = [];
              newKnowledgePoints[k].push(...v);
            });
          });

          const newKeys = Object.keys(newKnowledgePoints);
          console.log("è§£æåˆ°æ–°çš„çŸ¥è¯†ç‚¹:", newKeys);

          // æ‰¾åˆ°å½“å‰çŸ¥è¯†ç‚¹åœ¨åŸkeysä¸­çš„ç´¢å¼•
          const currentTabIndexInKeys = keys.indexOf(currentTab);
          console.log("å½“å‰çŸ¥è¯†ç‚¹åœ¨åŸkeysä¸­çš„ç´¢å¼•:", currentTabIndexInKeys);

          if (currentTabIndexInKeys === -1) {
            console.log("å½“å‰çŸ¥è¯†ç‚¹ä¸å­˜åœ¨äºåŸkeysä¸­ï¼Œç›´æ¥æ›¿æ¢æ‰€æœ‰æ•°æ®");
            // å¦‚æœå½“å‰çŸ¥è¯†ç‚¹ä¸å­˜åœ¨ï¼Œç›´æ¥æ›¿æ¢æ‰€æœ‰æ•°æ®
            rawData = newRawData;
            knowledgePoints = newKnowledgePoints;
            keys = newKeys;
          } else {
            console.log("ä¿ç•™å½“å‰çŸ¥è¯†ç‚¹ä¹‹å‰çš„æ•°æ®ï¼Œæ›´æ–°å½“å‰åŠä¹‹åçš„æ•°æ®");

            // ä¿ç•™å½“å‰çŸ¥è¯†ç‚¹ä¹‹å‰çš„æ•°æ®å’ŒçŠ¶æ€ï¼ˆä¸åŒ…æ‹¬å½“å‰çŸ¥è¯†ç‚¹ï¼‰
            const preservedKeys = keys.slice(0, currentTabIndexInKeys);
            console.log("éœ€è¦ä¿ç•™çš„çŸ¥è¯†ç‚¹ï¼ˆå½“å‰çŸ¥è¯†ç‚¹ä¹‹å‰ï¼‰:", preservedKeys);

            // æ›´æ–°rawData
            rawData = newRawData;

            // æ„å»ºæ–°çš„knowledgePointsï¼Œä¿ç•™å‰é¢çš„ï¼Œæ›´æ–°å½“å‰åŠåé¢çš„
            const updatedKnowledgePoints = {};

            // 1. ä¿ç•™å½“å‰çŸ¥è¯†ç‚¹ä¹‹å‰çš„çŸ¥è¯†ç‚¹æ•°æ®
            preservedKeys.forEach((key) => {
              if (knowledgePoints[key]) {
                updatedKnowledgePoints[key] = knowledgePoints[key];
                console.log("ä¿ç•™çŸ¥è¯†ç‚¹:", key);
              }
            });

            // 2. æ·»åŠ æ–°çš„çŸ¥è¯†ç‚¹æ•°æ®ï¼ˆåŒ…æ‹¬å½“å‰çŸ¥è¯†ç‚¹åŠä¹‹åçš„æ‰€æœ‰çŸ¥è¯†ç‚¹ï¼‰
            newKeys.forEach((key) => {
              if (newKnowledgePoints[key]) {
                updatedKnowledgePoints[key] = newKnowledgePoints[key];
                console.log("æ›´æ–°/æ·»åŠ çŸ¥è¯†ç‚¹:", key);
              }
            });

            // 3. æ„å»ºæœ€ç»ˆçš„keysæ•°ç»„ï¼šä¿ç•™çš„ + æ–°çš„æ‰€æœ‰çŸ¥è¯†ç‚¹
            // å…³é”®ä¿®å¤ï¼šç¡®ä¿ä¸ä¼šé‡å¤æ·»åŠ çŸ¥è¯†ç‚¹
            const finalKeys = [...preservedKeys];

            // æ·»åŠ æ–°çš„çŸ¥è¯†ç‚¹ï¼ˆé¿å…é‡å¤ï¼‰
            newKeys.forEach((key) => {
              if (!finalKeys.includes(key)) {
                finalKeys.push(key);
              }
            });

            // æ›´æ–°å…¨å±€å˜é‡
            knowledgePoints = updatedKnowledgePoints;
            keys = finalKeys;
            console.log("æœ€ç»ˆçš„çŸ¥è¯†ç‚¹åˆ—è¡¨:", keys);

            // å¯¹äºå½“å‰çŸ¥è¯†ç‚¹åŠä¹‹åçš„çŸ¥è¯†ç‚¹ï¼Œé‡æ–°åˆå§‹åŒ–æ•°æ®ç»“æ„
            const currentAndAfterKeys = keys.slice(currentTabIndexInKeys);
            console.log("éœ€è¦é‡æ–°åˆå§‹åŒ–çš„çŸ¥è¯†ç‚¹:", currentAndAfterKeys);

            currentAndAfterKeys.forEach((key) => {
              const keyIndex = keys.indexOf(key);

              // é‡ç½®æäº¤çŠ¶æ€ï¼ˆåªé‡ç½®å½“å‰çŸ¥è¯†ç‚¹ä¹‹åçš„çŸ¥è¯†ç‚¹ï¼Œå½“å‰çŸ¥è¯†ç‚¹ä¿æŒåŸçŠ¶æ€ï¼‰
              if (keyIndex > currentTabIndexInKeys) {
                console.log("é‡ç½®çŸ¥è¯†ç‚¹æäº¤çŠ¶æ€:", key);
                submittedTabs[key] = false;
                delete tabReports[key];
                // ä¸è¦è‡ªåŠ¨è§£é”æ‰€æœ‰çŸ¥è¯†ç‚¹ï¼Œä¿æŒé”å®šçŠ¶æ€
                unlockedTabs[key] = false;
              }

              // é‡æ–°åˆå§‹åŒ–ç”¨æˆ·ç­”æ¡ˆæ•°ç»„å’Œæç¤ºè®¡æ•°
              if (knowledgePoints[key]) {
                console.log("é‡æ–°åˆå§‹åŒ–çŸ¥è¯†ç‚¹æ•°æ®ç»“æ„:", key);
                userAnswers[key] = knowledgePoints[key].map(() => ({
                  answer: null,
                  accumulatedTime: 0,
                  isTiming: false,
                  lastStartTime: null,
                }));

                // é‡æ–°åˆå§‹åŒ–æç¤ºè®¡æ•°
                hintCounts[key] = knowledgePoints[key].map(() => 0);
              }
            });

            // ä¿®å¤è§£é”é€»è¾‘ï¼šæ ¹æ®å·²å®Œæˆçš„çŸ¥è¯†ç‚¹æ­£ç¡®è§£é”ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹
            console.log("å¼€å§‹ä¿®å¤è§£é”é€»è¾‘");
            for (let i = 0; i < keys.length; i++) {
              const key = keys[i];

              if (i === 0) {
                // ç¬¬ä¸€ä¸ªçŸ¥è¯†ç‚¹å§‹ç»ˆè§£é”
                unlockedTabs[key] = true;
                console.log("è§£é”ç¬¬ä¸€ä¸ªçŸ¥è¯†ç‚¹:", key);
              } else {
                const prevKey = keys[i - 1];
                // åªæœ‰å‰ä¸€ä¸ªçŸ¥è¯†ç‚¹å·²æäº¤æ—¶ï¼Œæ‰è§£é”å½“å‰çŸ¥è¯†ç‚¹
                if (submittedTabs[prevKey]) {
                  unlockedTabs[key] = true;
                  console.log(
                    "è§£é”çŸ¥è¯†ç‚¹:",
                    key,
                    "å› ä¸ºå‰ä¸€ä¸ªçŸ¥è¯†ç‚¹å·²å®Œæˆ:",
                    prevKey
                  );
                } else {
                  unlockedTabs[key] = false;
                  console.log(
                    "é”å®šçŸ¥è¯†ç‚¹:",
                    key,
                    "å› ä¸ºå‰ä¸€ä¸ªçŸ¥è¯†ç‚¹æœªå®Œæˆ:",
                    prevKey
                  );
                }
              }
            }
          }

          // æ›´æ–°currentTabIndexä»¥åŒ¹é…æ–°çš„keysæ•°ç»„
          currentTabIndex = keys.indexOf(currentTab);
          console.log("æ›´æ–°åçš„currentTabIndex:", currentTabIndex);

          // å¦‚æœå½“å‰çŸ¥è¯†ç‚¹å‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦é‡æ–°åŠ è½½
          if (currentTab && knowledgePoints[currentTab]) {
            console.log("é‡æ–°åŠ è½½å½“å‰çŸ¥è¯†ç‚¹å†…å®¹");
            // é‡ç½®åˆ°ç¬¬ä¸€é¢˜
            currentIndex = 0;

            // é‡æ–°åŠ è½½èµ„æºå†…å®¹å’Œé¢˜ç›®
            loadResourceContent();
            loadQuestion();

            // æ›´æ–°ç•Œé¢çŠ¶æ€
            updateButtonStates();
            updateProgressBar();

            // æ¸…é™¤ä»»ä½•åé¦ˆä¿¡æ¯
            feedbackEl.textContent = "";
            feedbackEl.className = "";

            // ç¡®ä¿ç­”æ¡ˆå®¹å™¨ä¸æ˜¯ç¦ç”¨çŠ¶æ€
            answerContainer.className = "";

            // ç¡®ä¿è®¡æ—¶å™¨çŠ¶æ€æ­£ç¡®
            timerContainer.classList.remove("submitted");
            if (!submittedTabs[currentTab]) {
              startTiming();
            }
          }

          // é‡æ–°æ„å»ºæ ‡ç­¾é¡µ
          buildTabs();
          console.log("å­¦ä¹ è·¯å¾„æ›´æ–°å®Œæˆ");

          return true;
        } catch (error) {
          console.error("æ›´æ–°å­¦ä¹ è·¯å¾„å¤±è´¥:", error);
          return false;
        }
      }

      // åˆ·æ–°å­¦ä¹ èµ„æº
      async function refreshLearningResources() {
        try {
          // é‡æ–°è·å–æ•°æ®
          const res = await fetch(apiUrl);
          const newRawData = await res.json();

          // æ›´æ–°å…¨å±€æ•°æ®
          rawData = newRawData;

          // é‡æ–°è§£æçŸ¥è¯†ç‚¹æ•°æ®
          const newKnowledgePoints = {};
          newRawData.forEach((item) => {
            const parsed = safeParseQuestions(item.questions);
            Object.entries(parsed).forEach(([k, v]) => {
              if (!newKnowledgePoints[k]) newKnowledgePoints[k] = [];
              newKnowledgePoints[k].push(...v);
            });
          });

          // ä¿®å¤BUG1ï¼šæ­£ç¡®æ›´æ–°é¢˜ç›®æ•°æ®
          knowledgePoints = newKnowledgePoints;
          keys = Object.keys(knowledgePoints);

          // é‡æ–°åˆå§‹åŒ–å½“å‰çŸ¥è¯†ç‚¹çš„æ•°æ®ç»“æ„
          if (currentTab && knowledgePoints[currentTab]) {
            // å…³é”®ä¿®å¤ï¼šé‡ç½®å½“å‰çŸ¥è¯†ç‚¹çš„æäº¤çŠ¶æ€ï¼Œå› ä¸ºé¢˜ç›®å·²ç»æ›´æ–°
            submittedTabs[currentTab] = false;

            // æ¸…é™¤ä¹‹å‰çš„æŠ¥å‘Šæ•°æ®
            delete tabReports[currentTab];

            // é‡æ–°åˆå§‹åŒ–ç”¨æˆ·ç­”æ¡ˆæ•°ç»„ï¼ˆæ¸…ç©ºæ‰€æœ‰ç­”æ¡ˆï¼Œå› ä¸ºé¢˜ç›®å·²æ›´æ–°ï¼‰
            const currentQuestions = knowledgePoints[currentTab];
            userAnswers[currentTab] = currentQuestions.map(() => ({
              answer: null,
              accumulatedTime: 0,
              isTiming: false,
              lastStartTime: null,
            }));

            // é‡æ–°åˆå§‹åŒ–æç¤ºè®¡æ•°
            hintCounts[currentTab] = currentQuestions.map(() => 0);

            // é‡ç½®åˆ°ç¬¬ä¸€é¢˜
            currentIndex = 0;
          }

          // é‡æ–°æ„å»ºæ ‡ç­¾é¡µ
          buildTabs();

          // é‡æ–°åŠ è½½å½“å‰çŸ¥è¯†ç‚¹çš„èµ„æºå†…å®¹å’Œé¢˜ç›®
          if (currentTab) {
            loadResourceContent();
            loadQuestion();

            // ç¡®ä¿ç•Œé¢çŠ¶æ€æ­£ç¡®æ›´æ–°
            updateButtonStates();
            updateProgressBar();

            // æ¸…é™¤ä»»ä½•åé¦ˆä¿¡æ¯
            feedbackEl.textContent = "";
            feedbackEl.className = "";

            // ç¡®ä¿ç­”æ¡ˆå®¹å™¨ä¸æ˜¯ç¦ç”¨çŠ¶æ€
            answerContainer.className = "";

            // ç¡®ä¿è®¡æ—¶å™¨çŠ¶æ€æ­£ç¡®
            timerContainer.classList.remove("submitted");
            if (!submittedTabs[currentTab]) {
              startTiming();
            }
          }

          return true;
        } catch (error) {
          console.error("åˆ·æ–°å­¦ä¹ èµ„æºå¤±è´¥:", error);
          return false;
        }
      }

      // æ›´æ¢èµ„æºç¡®è®¤æŒ‰é’®äº‹ä»¶ - ä¿®æ”¹ä¸ºä½¿ç”¨é€‰æ‹©çš„èµ„æºç±»å‹
      confirmResourceTypeBtn.onclick = async () => {
        console.log("ç¡®è®¤æ›´æ¢èµ„æºæŒ‰é’®è¢«ç‚¹å‡»"); // è°ƒè¯•ä¿¡æ¯

        if (!selectedResourceType) {
          alert("è¯·å…ˆé€‰æ‹©ä¸€ç§èµ„æºç±»å‹ï¼");
          return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        confirmResourceTypeBtn.disabled = true;
        confirmResourceTypeBtn.innerHTML =
          '<span class="loading-spinner"></span> å¤„ç†ä¸­...';

        try {
          // è°ƒç”¨æ›´æ¢èµ„æºAPIï¼Œä¼ å…¥é€‰æ‹©çš„èµ„æºç±»å‹
          const changeResult = await changeResourceAPI(
            currentTab,
            selectedResourceType
          );

          if (changeResult.success) {
            // åˆ·æ–°å­¦ä¹ èµ„æº
            const refreshSuccess = await refreshLearningResources();

            if (refreshSuccess) {
              // å…³é—­å¼¹çª—
              hideResourceChangeModal();

              // éšè—æ›´æ¢èµ„æºæŒ‰é’®ï¼ˆå› ä¸ºèµ„æºå·²ç»æ›´æ¢æˆåŠŸï¼‰
              hideChangeResourceButton();

              // è·³è½¬åˆ°å­¦ä¹ èµ„æºé¡µé¢ï¼Œè®©ç”¨æˆ·æŸ¥çœ‹æ–°èµ„æº
              document
                .querySelector('.content-tab[data-tab="resource"]')
                .click();

              // æ˜¾ç¤ºæˆåŠŸæç¤º
              feedbackEl.textContent = `ğŸ‰ å­¦ä¹ èµ„æºå’Œé¢˜ç›®å·²æ›´æ–°ï¼è¯·æŸ¥çœ‹æ–°çš„å­¦ä¹ èµ„æºåå¼€å§‹ç»ƒä¹ ã€‚`;
              feedbackEl.className = "success-feedback";

              setTimeout(() => {
                feedbackEl.textContent = "";
                feedbackEl.className = "";
              }, 5000);
            } else {
              // åˆ·æ–°å¤±è´¥
              feedbackEl.textContent = "âŒ èµ„æºæ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
              feedbackEl.className = "error-feedback";

              setTimeout(() => {
                feedbackEl.textContent = "";
                feedbackEl.className = "";
              }, 3000);
            }
          } else {
            // APIè°ƒç”¨å¤±è´¥
            alert(`æ›´æ¢èµ„æºå¤±è´¥ï¼š${changeResult.error}`);
          }
        } catch (error) {
          console.error("å¤„ç†æ›´æ¢èµ„æºè¯·æ±‚æ—¶å‡ºé”™:", error);
          alert("å¤„ç†è¯·æ±‚æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          confirmResourceTypeBtn.disabled = false;
          confirmResourceTypeBtn.innerHTML = "ç¡®è®¤é€‰æ‹©";
        }
      };

      // å–æ¶ˆæ›´æ¢èµ„æºæŒ‰é’®äº‹ä»¶ - ä¿®æ”¹ä¸ºæ˜¾ç¤ºæ›´æ¢èµ„æºæŒ‰é’®
      cancelChangeBtn.onclick = () => {
        console.log("å–æ¶ˆæ›´æ¢èµ„æºæŒ‰é’®è¢«ç‚¹å‡»"); // è°ƒè¯•ä¿¡æ¯
        hideResourceChangeModal();

        // æ˜¾ç¤ºæ›´æ¢èµ„æºæŒ‰é’®ï¼Œè®©ç”¨æˆ·å¯ä»¥å†æ¬¡é€‰æ‹©æ›´æ¢èµ„æº
        showChangeResourceButton();
      };

      // å­¦ä¹ è·¯å¾„æ›´æ¢ç¡®è®¤æŒ‰é’®äº‹ä»¶ - ä¿®æ”¹ä¸ºè°ƒç”¨æ–°APIå¹¶å¤„ç†è¿”å›ç»“æœ
      confirmPathChangeBtn.onclick = async () => {
        console.log("ç¡®è®¤æ›´æ¢å­¦ä¹ è·¯å¾„æŒ‰é’®è¢«ç‚¹å‡»"); // è°ƒè¯•ä¿¡æ¯

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        confirmPathChangeBtn.disabled = true;
        confirmPathChangeBtn.innerHTML =
          '<span class="loading-spinner"></span> å¤„ç†ä¸­...';

        try {
          // è·å–å½“å‰å­¦ä¹ æ¬¡æ•°ï¼ˆå‡è®¾ä»æœ€è¿‘çš„æäº¤ç»“æœè·å–ï¼‰
          const currentCount = tabReports[currentTab]?.learningCount || 4; // é»˜è®¤ä¸º4æ¬¡ï¼ˆè¶…è¿‡3æ¬¡ï¼‰

          // è°ƒç”¨æ›´æ¢å­¦ä¹ è·¯å¾„API
          const changeResult = await changePathAPI(currentTab, currentCount);

          if (changeResult.success) {
            // å…³é—­å½“å‰å¼¹çª—
            hidePathChangeModal();

            // æ£€æŸ¥è¿”å›æ•°æ®æ ¼å¼
            const responseData = changeResult.data;
            console.log("è·¯å¾„æ›´æ¢APIè¿”å›çš„å®Œæ•´æ•°æ®:", responseData);

            // ç¨ä½œå»¶æ—¶å†æ˜¾ç¤ºè·¯å¾„é€‰æ‹©å¼¹çª—ï¼Œç¡®ä¿å‰ä¸€ä¸ªå¼¹çª—å®Œå…¨å…³é—­
            setTimeout(() => {
              if (
                responseData.python_output &&
                responseData.python_output.final_plan
              ) {
                console.log("å‡†å¤‡æ˜¾ç¤ºè·¯å¾„é€‰æ‹©å¼¹çª—");
                showPathSelectionModal(responseData);
              } else {
                // å¦‚æœæ²¡æœ‰è·¯å¾„æ¨èï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º
                feedbackEl.textContent =
                  "ğŸ‰ å­¦ä¹ è·¯å¾„è°ƒæ•´æˆåŠŸï¼ç³»ç»Ÿå·²ä¸ºæ‚¨åˆ¶å®šäº†æ›´é€‚åˆçš„å­¦ä¹ è®¡åˆ’ã€‚";
                feedbackEl.className = "success-feedback";

                setTimeout(() => {
                  feedbackEl.textContent = "";
                  feedbackEl.className = "";
                }, 3000);
              }
            }, 300); // 300mså»¶æ—¶ç¡®ä¿å¼¹çª—åˆ‡æ¢é¡ºç•…
          } else {
            // APIè°ƒç”¨å¤±è´¥
            alert(`å­¦ä¹ è·¯å¾„è°ƒæ•´å¤±è´¥ï¼š${changeResult.error}`);
          }
        } catch (error) {
          console.error("å¤„ç†å­¦ä¹ è·¯å¾„è°ƒæ•´è¯·æ±‚æ—¶å‡ºé”™:", error);
          alert("å¤„ç†è¯·æ±‚æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          confirmPathChangeBtn.disabled = false;
          confirmPathChangeBtn.innerHTML = "æ˜¯ï¼Œè°ƒæ•´å­¦ä¹ è·¯å¾„";
        }
      };

      // å–æ¶ˆæ›´æ¢å­¦ä¹ è·¯å¾„æŒ‰é’®äº‹ä»¶ - ä¿®æ”¹ä¸ºæ ¹æ®æƒ…å†µæ˜¾ç¤ºèµ„æºæ›´æ¢å¼¹çª—ï¼ˆä¼ å…¥æŒæ¡çŠ¶æ€ï¼‰
      cancelPathChangeBtn.onclick = () => {
        console.log("å–æ¶ˆæ›´æ¢å­¦ä¹ è·¯å¾„æŒ‰é’®è¢«ç‚¹å‡»"); // è°ƒè¯•ä¿¡æ¯
        hidePathChangeModal();

        // å¦‚æœå­¦ä¹ æ¬¡æ•°è¶…è¿‡3æ¬¡ä¸”ç”¨æˆ·æ‹’ç»æ›´æ¢è·¯å¾„ï¼Œæ˜¾ç¤ºèµ„æºæ›´æ¢å¼¹çª—
        const currentCount = tabReports[currentTab]?.learningCount || 0;
        if (currentCount > 3) {
          isFromPathRejection = true; // æ ‡è®°æ¥è‡ªè·¯å¾„æ‹’ç»
          // è·å–å½“å‰çŸ¥è¯†ç‚¹çš„æŒæ¡çŠ¶æ€ï¼Œä¼ å…¥å¼¹çª—
          const masteryStatus =
            tabReports[currentTab]?.masteryResult || "æœªæŒæ¡";
          setTimeout(() => {
            showResourceChangeModal(masteryStatus);
          }, 500);
        }
      };

      // æ–°å¢ï¼šè·¯å¾„é€‰æ‹©å¼¹çª—äº‹ä»¶å¤„ç† - ä¿®æ”¹ä¸ºè°ƒç”¨æ›´æ–°å­¦ä¹ è·¯å¾„å‡½æ•°
      confirmNewPathBtn.onclick = async () => {
        console.log("ç¡®è®¤é‡‡ç”¨æ–°è·¯å¾„æŒ‰é’®è¢«ç‚¹å‡»"); // è°ƒè¯•ä¿¡æ¯

        if (!pathChangeData || !pathChangeData.python_output) {
          alert("è·¯å¾„æ•°æ®é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚");
          return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        confirmNewPathBtn.disabled = true;
        confirmNewPathBtn.innerHTML =
          '<span class="loading-spinner"></span> å¤„ç†ä¸­...';

        try {
          // è°ƒç”¨ç¡®è®¤è·¯å¾„æ›´æ¢API
          const confirmResult = await confirmPathChangeAPI(
            pathChangeData.python_output
          );

          if (confirmResult.success) {
            // å…³é—­å¼¹çª—
            hidePathSelectionModal();

            // æ›´æ–°å­¦ä¹ è·¯å¾„æ•°æ®ï¼ˆåªæ›´æ–°å½“å‰çŸ¥è¯†ç‚¹åŠä¹‹åçš„çŸ¥è¯†ç‚¹ï¼‰
            const updateSuccess = await updateLearningPath();

            if (updateSuccess) {
              // æ˜¾ç¤ºæˆåŠŸæç¤º
              feedbackEl.textContent =
                "ğŸ‰ æ–°å­¦ä¹ è·¯å¾„å·²å¯ç”¨ï¼ç³»ç»Ÿå·²æ›´æ–°åç»­å­¦ä¹ å†…å®¹ï¼Œå·²å®Œæˆçš„çŸ¥è¯†ç‚¹çŠ¶æ€ä¿æŒä¸å˜ã€‚";
              feedbackEl.className = "success-feedback";

              // åˆ‡æ¢åˆ°å­¦ä¹ èµ„æºé¡µé¢ï¼Œè®©ç”¨æˆ·æŸ¥çœ‹æ–°å†…å®¹
              document
                .querySelector('.content-tab[data-tab="resource"]')
                .click();

              setTimeout(() => {
                feedbackEl.textContent = "";
                feedbackEl.className = "";
              }, 5000);
            } else {
              // æ›´æ–°å¤±è´¥
              feedbackEl.textContent = "âŒ å­¦ä¹ è·¯å¾„æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
              feedbackEl.className = "error-feedback";

              setTimeout(() => {
                feedbackEl.textContent = "";
                feedbackEl.className = "";
              }, 3000);
            }
          } else {
            // APIè°ƒç”¨å¤±è´¥
            alert(`è·¯å¾„æ›´æ¢å¤±è´¥ï¼š${confirmResult.error}`);
          }
        } catch (error) {
          console.error("å¤„ç†è·¯å¾„ç¡®è®¤è¯·æ±‚æ—¶å‡ºé”™:", error);
          alert("å¤„ç†è¯·æ±‚æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          confirmNewPathBtn.disabled = false;
          confirmNewPathBtn.innerHTML = "é‡‡ç”¨æ–°è·¯å¾„";
        }
      };

      rejectNewPathBtn.onclick = () => {
        console.log("æ‹’ç»æ–°è·¯å¾„æŒ‰é’®è¢«ç‚¹å‡»"); // è°ƒè¯•ä¿¡æ¯
        hidePathSelectionModal();

        // æ˜¾ç¤ºè¿”å›ä¸»é¡µæç¤ºå¼¹çª—
        setTimeout(() => {
          showReturnHomeModal();
        }, 500);
      };

      // æ–°å¢ï¼šè¿”å›ä¸»é¡µå¼¹çª—äº‹ä»¶å¤„ç†
      goHomeBtn.onclick = () => {
        console.log("è¿”å›ä¸»é¡µæŒ‰é’®è¢«ç‚¹å‡»"); // è°ƒè¯•ä¿¡æ¯

        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è¿”å›ä¸»é¡µçš„é€»è¾‘
        // ä¾‹å¦‚ï¼šwindow.location.href = '/';
        alert("å³å°†è¿”å›ä¸»é¡µï¼Œè¯·åœ¨å¯¹è¯æ¡†ä¸­æè¿°æ‚¨çš„å­¦ä¹ éœ€æ±‚ã€‚");
        window.location.href = "http://127.0.0.1:5500/AI_teacher.html";
        hideReturnHomeModal();
      };

      stayCurrentBtn.onclick = () => {
        console.log("ç»§ç»­å½“å‰å­¦ä¹ æŒ‰é’®è¢«ç‚¹å‡»"); // è°ƒè¯•ä¿¡æ¯
        hideReturnHomeModal();

        // æ˜¾ç¤ºæˆåŠŸæç¤º
        feedbackEl.textContent = "ğŸ“š å°†ç»§ç»­å½“å‰å­¦ä¹ è·¯å¾„ï¼ŒåŠ æ²¹å­¦ä¹ ï¼";
        feedbackEl.className = "success-feedback";

        setTimeout(() => {
          feedbackEl.textContent = "";
          feedbackEl.className = "";
        }, 3000);
      };

      // æ–°å¢ï¼šå­¦ä¹ å®Œæˆæé†’ç¡®è®¤æŒ‰é’®äº‹ä»¶ - ä¿®æ”¹ä¸ºæ›´æ–°æŒ‰é’®çŠ¶æ€
      understandReminderBtn.onclick = () => {
        console.log("æˆ‘çŸ¥é“äº†æŒ‰é’®è¢«ç‚¹å‡»");

        // æ ‡è®°å·²æ˜¾ç¤ºè¿‡å®Œæˆæé†’
        hasShownCompletionReminder = true;

        // éšè—å¼¹çª—
        hideCompletionReminderModal();

        // æ›´æ–°æŸ¥çœ‹æç¤ºæŒ‰é’®çŠ¶æ€
        updateHintButtonState();
      };

      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      resourceChangeModal.onclick = (event) => {
        if (event.target === resourceChangeModal) {
          hideResourceChangeModal();
        }
      };

      pathChangeModal.onclick = (event) => {
        if (event.target === pathChangeModal) {
          hidePathChangeModal();
        }
      };

      pathSelectionModal.onclick = (event) => {
        if (event.target === pathSelectionModal) {
          hidePathSelectionModal();
        }
      };

      returnHomeModal.onclick = (event) => {
        if (event.target === returnHomeModal) {
          hideReturnHomeModal();
        }
      };

      completionReminderModal.onclick = (event) => {
        if (event.target === completionReminderModal) {
          hideCompletionReminderModal();
        }
      };

      // å®‰å…¨è§£æé—®é¢˜æ•°æ® - é’ˆå¯¹æ–°çš„æ•°æ®æ ¼å¼
      function safeParseQuestions(str) {
        try {
          const replaced = str.replace(/'/g, "");

          const replaced3 = replaced
            .replace(/\\\\([()])/g, "")
            .replace(/\\\\/g, "");

          const parsed = JSON.parse(replaced3);

          // å¤„ç†æ–°çš„æ•°æ®æ ¼å¼
          const result = {};
          Object.entries(parsed).forEach(([knowledgePoint, questions]) => {
            result[knowledgePoint] = questions.map((q) => ({
              question: q.question_text,
              type: q.question_type,
              options: q.options
                ? typeof q.options === "string"
                  ? JSON.parse(q.options)
                  : q.options
                : {},
              answer: q.answer,
              explanation: q.explanation,
              question_number: q.question_number,
            }));
          });

          return result;
        } catch (e) {
          console.error("è§£æå¤±è´¥", e);
          return {};
        }
      }

      // åˆå§‹åŒ–é¡µé¢
      async function init() {
        try {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          tabsEl.innerHTML =
            '<div class="text-center p-4"><div class="loading-spinner mx-auto"></div><p class="mt-2 text-sm text-gray-500">æ­£åœ¨åŠ è½½é¢˜ç›®...</p></div>';

          const res = await fetch(apiUrl);
          const res2 = await fetch(apiUrlUser);

          id = await res2.json();

          user_id = id[0].user_id;
          console.log(user_id);

          rawData = await res.json();
          console.log(rawData);
          rawData.forEach((item) => {
            const parsed = safeParseQuestions(item.questions);
            Object.entries(parsed).forEach(([k, v]) => {
              if (!knowledgePoints[k]) knowledgePoints[k] = [];
              knowledgePoints[k].push(...v);
            });
          });
          keys = Object.keys(knowledgePoints);

          // é»˜è®¤è§£é”ç¬¬ä¸€ä¸ªçŸ¥è¯†ç‚¹
          if (keys.length > 0) {
            unlockedTabs[keys[0]] = true;
          }

          buildTabs();
          switchTab(keys[0]);
        } catch (error) {
          console.error("åˆå§‹åŒ–å¤±è´¥:", error);
          tabsEl.innerHTML =
            '<div class="text-center p-4 text-red-500"><p>åŠ è½½é¢˜ç›®å¤±è´¥</p><p class="text-sm mt-1">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</p></div>';
        }
      }

      // æ„å»ºçŸ¥è¯†ç‚¹æ ‡ç­¾ - ä¿®æ”¹ä¸ºæ”¯æŒé‡å¤å­¦ä¹ æ ‡è¯†
      function buildTabs() {
        tabsEl.innerHTML = "";
        keys.forEach((key, index) => {
          const tab = document.createElement("div");
          tab.className = "tab";
          tab.dataset.key = key;

          const isSubmitted = submittedTabs[key];
          const isUnlocked = unlockedTabs[key] || isSubmitted;
          const isLocked = !isUnlocked;

          const progress = getProgress(key);

          // æ£€æŸ¥æ˜¯å¦æ˜¯é‡å¤å­¦ä¹ è¶…è¿‡3æ¬¡çš„çŸ¥è¯†ç‚¹
          const report = tabReports[key];
          const isRepeatedLearning =
            report &&
            report.learningCount > 3 &&
            report.masteryResult !== "æœªæŒæ¡";

          let tabInnerHTML = `<span class="font-heading">${key}</span><span class="progress-text">${progress.done}/${progress.total}</span>`;

          // å¦‚æœæ˜¯é‡å¤å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œåœ¨çŸ¥è¯†ç‚¹åé¢æ·»åŠ å­¦ä¹ æ¬¡æ•°æç¤º
          if (isRepeatedLearning) {
            tabInnerHTML = `<span class="font-heading">${key} <span class="learning-count-badge">å­¦ä¹ ${report.learningCount}æ¬¡</span></span><span class="progress-text">${progress.done}/${progress.total}</span>`;
          }

          tab.innerHTML = tabInnerHTML;

          if (isSubmitted) {
            if (isRepeatedLearning) {
              // é‡å¤å­¦ä¹ çš„çŸ¥è¯†ç‚¹æ˜¾ç¤ºä¸ºé»„è‰²
              tab.classList.add("repeated-learning");
            } else {
              // æ­£å¸¸æŒæ¡çš„çŸ¥è¯†ç‚¹æ˜¾ç¤ºä¸ºç»¿è‰²
              tab.classList.add("submitted");
            }
          }

          if (isLocked) {
            tab.classList.add("locked");
          } else {
            tab.onclick = () => switchTab(key);
          }

          if (key === currentTab) {
            tab.classList.add("active");
          }

          tabsEl.appendChild(tab);
        });
      }

      // è·å–å½“å‰çŸ¥è¯†ç‚¹è¿›åº¦
      // æ›¿æ¢ getProgress å‡½æ•°
      function getProgress(key) {
        const total = knowledgePoints[key]?.length || 0;

        // å¦‚æœå·²æäº¤ï¼Œåˆ™æ˜¾ç¤º100%å®Œæˆ
        if (submittedTabs[key]) {
          return { done: total, total };
        }

        // è®¡ç®—å·²å®Œæˆçš„é¢˜ç›®æ•°é‡ï¼ˆæ— è®ºä»€ä¹ˆé¢˜å‹ï¼Œåªè¦æœ‰ç­”æ¡ˆå°±ç®—å®Œæˆï¼‰
        const done = (userAnswers[key] || []).filter(
          (a) => a.answer !== null && a.answer !== undefined && a.answer !== ""
        ).length;

        return { done, total };
      }

      // å®æ—¶ä¿å­˜ç­”æ¡ˆï¼ˆä¸å¤„ç†è®¡æ—¶ï¼‰
      // å®æ—¶ä¿å­˜ç­”æ¡ˆï¼ˆä¸å¤„ç†è®¡æ—¶ï¼‰
      function saveCurrentAnswerInstant() {
        if (!currentTab || !userAnswers[currentTab]?.[currentIndex]) return;

        // æ£€æŸ¥é¢˜ç›®ç±»å‹
        const q = knowledgePoints[currentTab][currentIndex];

        if (q.type === "ç®€ç­”é¢˜" || q.type === "è¯æ˜é¢˜") {
          // ç®€ç­”é¢˜çš„ç­”æ¡ˆå·²ç»åœ¨ handleShortAnswerInput ä¸­ä¿å­˜
          return;
        }

        // å¯¹äºé€‰æ‹©é¢˜å’Œåˆ¤æ–­é¢˜
        const selectedOption = answerContainer.querySelector(
          ".option-item.selected"
        );
        if (selectedOption) {
          const answer = selectedOption.dataset.value;
          const userData = userAnswers[currentTab][currentIndex];
          userData.answer = answer;
          updateButtonStates(); // æ›´æ–°æŒ‰é’®çŠ¶æ€
          buildTabs(); // æ›´æ–°æ ‡ç­¾é¡µè¿›åº¦æ˜¾ç¤º
          updateProgressBar(); // æ›´æ–°è¿›åº¦æ¡
        }
      }

      // åˆ‡æ¢çŸ¥è¯†ç‚¹
      function switchTab(key) {
        // ä¿å­˜å½“å‰ç­”æ¡ˆå’Œè®¡æ—¶çŠ¶æ€
        saveCurrentAnswer();
        stopCurrentTiming();

        // åˆå§‹åŒ–æ–°çŸ¥è¯†ç‚¹çš„æ•°æ®
        initializeTabData(key);

        currentTab = key;
        currentIndex = 0;
        currentTabIndex = keys.indexOf(key);
        // é‡ç½®å¿ƒæƒ…è‡ªåŠ¨æ›´æ–°çŠ¶æ€
        moodAutoUpdateEnabled = true;
        document.querySelector(".mood-auto-indicator span").textContent =
          "è‡ªåŠ¨æ£€æµ‹ä¸­...";

        buildTabs();
        loadQuestion();

        // åˆ‡æ¢çŸ¥è¯†ç‚¹æ—¶ï¼Œé»˜è®¤æ˜¾ç¤ºå­¦ä¹ èµ„æºé¢æ¿å¹¶æ­£ç¡®è®¾ç½®UIçŠ¶æ€
        switchToResourcePanel();

        // åˆ‡æ¢çŸ¥è¯†ç‚¹æ—¶éšè—æ›´æ¢èµ„æºæŒ‰é’®ï¼ˆæ¯ä¸ªçŸ¥è¯†ç‚¹éƒ½æ˜¯ç‹¬ç«‹çš„ï¼‰
        hideChangeResourceButton();
      }

      // åˆ‡æ¢åˆ°èµ„æºé¢æ¿
      function switchToResourcePanel() {
        const buttonGroup = document.querySelector(".button-group");
        const timerContainer = document.getElementById("timer-container");
        const questionHeader = document.getElementById("question-header");
        const progressBarContainer = document.getElementById(
          "progress-bar-container"
        );

        // åœæ­¢è®¡æ—¶
        stopCurrentTiming();

        // æ›´æ–°tabçŠ¶æ€
        document
          .querySelector('.content-tab[data-tab="resource"]')
          .classList.add("active");
        document
          .querySelector('.content-tab[data-tab="question"]')
          .classList.remove("active");
        document.getElementById("resource-panel").classList.add("active");
        document.getElementById("question-panel").classList.remove("active");

        // éšè—é¢˜ç›®ç»ƒä¹ ç›¸å…³å…ƒç´ 
        buttonGroup.style.display = "none";
        timerContainer.style.display = "none";
        progressBarContainer.style.display = "none";
        questionHeader.style.display = "none";

        // åŠ è½½èµ„æºå†…å®¹
        loadResourceContent();
      }

      // åˆå§‹åŒ–æ ‡ç­¾é¡µæ•°æ®
      function initializeTabData(key) {
        if (!hintCounts[key]) {
          hintCounts[key] = knowledgePoints[key].map(() => 0);
        }

        if (!userAnswers[key]) {
          userAnswers[key] = knowledgePoints[key].map(() => ({
            answer: null,
            accumulatedTime: 0,
            isTiming: false,
            lastStartTime: null,
          }));
        }
        if (!userMoods[key]) {
          userMoods[key] = knowledgePoints[key].map(() => ({
            moods: ["ä¸“æ³¨"], // é»˜è®¤é€‰æ‹©ä¸“æ³¨
            autoSelected: true,
          }));
        }
      }

      // ç”Ÿæˆé€‰æ‹©é¢˜é€‰é¡¹
      function generateChoiceOptions(options, userAnswer, isDisabled) {
        let html = "";
        Object.entries(options).forEach(([key, value]) => {
          const isSelected = userAnswer === key;
          html += `
            <div class="option-item ${isSelected ? "selected" : ""} ${
            isDisabled ? "disabled" : ""
          }" 
                 data-value="${key}" 
                 onclick="${isDisabled ? "" : `selectOption('${key}')`}">
              <div class="option-radio"></div>
              <div class="option-label">${key}</div>
              <div class="option-text">${value}</div>
            </div>
          `;
        });
        return html;
      }

      // ç”Ÿæˆåˆ¤æ–­é¢˜é€‰é¡¹
      function generateJudgmentOptions(userAnswer, isDisabled) {
        const options = [
          { key: "å¯¹", value: "æ­£ç¡®" },
          { key: "é”™", value: "é”™è¯¯" },
        ];

        let html = "";
        options.forEach((option) => {
          const isSelected = userAnswer === option.key;
          html += `
            <div class="option-item ${isSelected ? "selected" : ""} ${
            isDisabled ? "disabled" : ""
          }" 
                 data-value="${option.key}" 
                 onclick="${isDisabled ? "" : `selectOption('${option.key}')`}">
              <div class="option-radio"></div>
              
              <div class="option-text">${option.value}</div>
            </div>
          `;
        });
        return html;
      }
      // ç”Ÿæˆç®€ç­”é¢˜è¾“å…¥æ¡†
      function generateShortAnswerOptions(userAnswer, isDisabled) {
        const answer = userAnswer || "";
        const disabledAttr = isDisabled ? "disabled" : "";
        return `
    <div class="short-answer-container">
      <textarea 
        class="short-answer-input" 
        placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ..." 
        ${disabledAttr}
        oninput="handleShortAnswerInput(this.value)"
      >${answer}</textarea>
    </div>
  `;
      }
      // å¤„ç†ç®€ç­”é¢˜è¾“å…¥
      function handleShortAnswerInput(value) {
        if (submittedTabs[currentTab]) return;

        // ä¿å­˜ç­”æ¡ˆ
        if (userAnswers[currentTab] && userAnswers[currentTab][currentIndex]) {
          userAnswers[currentTab][currentIndex].answer = value;
          updateButtonStates(); // ç¡®ä¿åœ¨è¾“å…¥æ—¶æ›´æ–°æŒ‰é’®çŠ¶æ€
          buildTabs(); // æ›´æ–°æ ‡ç­¾é¡µè¿›åº¦æ˜¾ç¤º
          updateProgressBar(); // æ›´æ–°è¿›åº¦æ¡
        }
      }

      // é€‰æ‹©é€‰é¡¹
      function selectOption(value) {
        if (submittedTabs[currentTab]) return;

        // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
        answerContainer.querySelectorAll(".option-item").forEach((item) => {
          item.classList.remove("selected");
        });

        // æ·»åŠ æ–°çš„é€‰æ‹©
        const selectedItem = answerContainer.querySelector(
          `[data-value="${value}"]`
        );
        if (selectedItem) {
          selectedItem.classList.add("selected");
        }

        // ä¿å­˜ç­”æ¡ˆ
        saveCurrentAnswerInstant();
        updateButtonStates();
        buildTabs(); // æ›´æ–°æ ‡ç­¾é¡µè¿›åº¦æ˜¾ç¤º
      }

      // åŠ è½½é¢˜ç›®
      function loadQuestion() {
        if (!currentTab) return;

        const userData = userAnswers[currentTab][currentIndex];
        const q = knowledgePoints[currentTab][currentIndex];
        const isSubmitted = submittedTabs[currentTab];

        // æ›´æ–°é¢˜ç›®å®¹å™¨çš„ç±»å
        questionContainer.className = `font-mono ${
          q.type === "é€‰æ‹©é¢˜" ? "choice-question" : "judgment-question"
        }`;

        // æ›´æ–°é¢˜ç›®ç±»å‹å¾½ç« 
        const badge = questionContainer.querySelector(".question-type-badge");
        badge.textContent = q.type;

        // æ›´æ–°é¢˜ç›®æ˜¾ç¤º
        questionText.textContent = q.question;
        questionNumberEl.textContent = `ç¬¬ ${currentIndex + 1} é¢˜ / å…± ${
          knowledgePoints[currentTab].length
        } é¢˜`;

        // ç”Ÿæˆç­”æ¡ˆé€‰é¡¹
        let optionsHtml = "";
        if (q.type === "é€‰æ‹©é¢˜") {
          optionsHtml = generateChoiceOptions(
            q.options,
            userData.answer,
            isSubmitted
          );
        } else if (q.type === "åˆ¤æ–­é¢˜") {
          optionsHtml = generateJudgmentOptions(userData.answer, isSubmitted);
        } else if (q.type === "ç®€ç­”é¢˜" || q.type === "è¯æ˜é¢˜") {
          optionsHtml = generateShortAnswerOptions(
            userData.answer,
            isSubmitted
          );
        }

        answerContainer.innerHTML = optionsHtml;
        answerContainer.className = isSubmitted ? "disabled" : "";

        // é‡ç½®åé¦ˆ
        feedbackEl.textContent = "";
        feedbackEl.className = "";

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateButtonStates();

        // æ›´æ–°è¿›åº¦æ¡
        updateProgressBar();

        // å¤„ç†è®¡æ—¶æ˜¾ç¤º
        updateTimerState();
        // æ›´æ–°å¿ƒæƒ…é¢æ¿
        updateMoodPanel();
      }

      // æ›´æ–°å¿ƒæƒ…é¢æ¿çŠ¶æ€
      function updateMoodPanel() {
        if (!currentTab) return;

        const moodData = userMoods[currentTab][currentIndex];
        const checkboxes = document.querySelectorAll(
          '#mood-panel input[type="checkbox"]'
        );

        // é‡ç½®æ‰€æœ‰é€‰é¡¹
        checkboxes.forEach((checkbox) => {
          checkbox.checked = false;
        });

        // æ ¹æ®å½“å‰é¢˜ç›®è®¾ç½®å¿ƒæƒ…é€‰é¡¹
        moodData.moods.forEach((mood) => {
          const checkbox = document.querySelector(
            `#mood-panel input[value="${mood}"]`
          );
          if (checkbox) {
            checkbox.checked = true;
          }
        });

        // æ›´æ–°è‡ªåŠ¨æ£€æµ‹çŠ¶æ€æ˜¾ç¤º
        const indicator = document.querySelector(".mood-auto-indicator span");
        if (moodAutoUpdateEnabled && moodData.autoSelected) {
          indicator.textContent = "è‡ªåŠ¨æ£€æµ‹ä¸­...";
        } else if (!moodData.autoSelected) {
          indicator.textContent = "æ‰‹åŠ¨é€‰æ‹©";
        }
      }

      // ä¿å­˜å½“å‰å¿ƒæƒ…çŠ¶æ€
      function saveCurrentMood() {
        if (!currentTab) return;

        const checkboxes = document.querySelectorAll(
          '#mood-panel input[type="checkbox"]:checked'
        );
        const selectedMoods = Array.from(checkboxes).map((cb) => cb.value);

        userMoods[currentTab][currentIndex] = {
          moods: selectedMoods,
          autoSelected: !moodAutoUpdateEnabled, // å¦‚æœæ˜¯æ‰‹åŠ¨é€‰æ‹©ï¼Œåˆ™æ ‡è®°ä¸ºéè‡ªåŠ¨é€‰æ‹©
        };
      }
      // æ·»åŠ å†…å®¹ tab åˆ‡æ¢åŠŸèƒ½
      document.addEventListener("DOMContentLoaded", function () {
        const contentTabs = document.querySelectorAll(".content-tab");
        const contentPanels = document.querySelectorAll(".content-panel");
        const buttonGroup = document.querySelector(".button-group");
        const timerContainer = document.getElementById("timer-container");
        const questionHeader = document.getElementById("question-header");
        const progressBarContainer = document.getElementById(
          "progress-bar-container"
        );

        contentTabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            const tabName = tab.getAttribute("data-tab");

            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ¿€æ´»çš„ tabï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            if (tab.classList.contains("active")) {
              return;
            }

            // ä¿å­˜å½“å‰ç­”æ¡ˆå’Œè®¡æ—¶çŠ¶æ€
            saveCurrentAnswer();

            // æ ¹æ®å½“å‰é¢æ¿å†³å®šæ˜¯å¦åœæ­¢è®¡æ—¶
            if (tabName === "resource") {
              // åˆ‡æ¢åˆ°èµ„æºé¢æ¿æ—¶åœæ­¢è®¡æ—¶
              stopCurrentTiming();
            }

            // æ›´æ–° tab æ¿€æ´»çŠ¶æ€
            contentTabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");

            // æ˜¾ç¤ºå¯¹åº”é¢æ¿
            contentPanels.forEach((panel) => {
              panel.classList.remove("active");
              if (panel.id === `${tabName}-panel`) {
                panel.classList.add("active");
              }
            });

            // æ ¹æ®å½“å‰é¢æ¿æ§åˆ¶å…ƒç´ æ˜¾ç¤º
            if (tabName === "question") {
              // é¢˜ç›®ç»ƒä¹ é¢æ¿æ˜¾ç¤ºæ‰€æœ‰å…ƒç´ 
              buttonGroup.style.display = "flex";
              timerContainer.style.display = "flex";
              progressBarContainer.style.display = "block";
              questionHeader.style.display = "flex";
              questionHeader.style.justifyContent = "space-between";

              // åˆ‡æ¢å›é¢˜ç›®é¢æ¿æ—¶æ¢å¤è®¡æ—¶
              if (currentTab && !submittedTabs[currentTab]) {
                startTiming();
              }
            } else {
              // èµ„æºé¢æ¿éšè—ä¸éœ€è¦çš„å…ƒç´ 
              buttonGroup.style.display = "none";
              timerContainer.style.display = "none";
              progressBarContainer.style.display = "none";
              questionHeader.style.display = "none";
            }

            // å¦‚æœåˆ‡æ¢åˆ°èµ„æºé¢æ¿ï¼ŒåŠ è½½èµ„æºå†…å®¹
            if (tabName === "resource") {
              loadResourceContent();
            }
          });
        });
      });

      // æ”¹è¿›çš„èµ„æºå†…å®¹åŠ è½½å‡½æ•°
      function loadResourceContent() {
        if (!currentTab || !rawData) return;

        const resourceTitle = document.getElementById("resource-title");
        const resourceContent = document.getElementById("resource-content");

        resourceTitle.textContent = `${currentTab} - å­¦ä¹ èµ„æº`;

        // æŸ¥æ‰¾å½“å‰çŸ¥è¯†ç‚¹çš„èµ„æº
        const currentResource = rawData.find((item) => {
          const knowledgePointsInItem = Object.keys(
            safeParseQuestions(item.questions)
          );
          return knowledgePointsInItem.includes(currentTab);
        });

        if (currentResource && currentResource.resources) {
          try {
            let resources = currentResource.resources;

            // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
            if (typeof resources === "string") {
              resources = JSON.parse(resources);
            }

            resourceContent.innerHTML = "";

            if (Array.isArray(resources)) {
              // å¤„ç†æ•°ç»„æ ¼å¼çš„èµ„æº
              resources.forEach((resource, index) => {
                const resourceCard = createResourceCard(resource, index);
                resourceContent.appendChild(resourceCard);
              });
            } else if (typeof resources === "object") {
              // å¤„ç†å¯¹è±¡æ ¼å¼çš„èµ„æº
              Object.entries(resources).forEach(([key, resource], index) => {
                const resourceCard = createResourceCard(resource, index);
                resourceContent.appendChild(resourceCard);
              });
            } else {
              // å¤„ç†å…¶ä»–æ ¼å¼
              const resourceCard = createResourceCard(resources, 0);
              resourceContent.appendChild(resourceCard);
            }
          } catch (e) {
            resourceContent.innerHTML = createEmptyState("èµ„æºå†…å®¹è§£æå¤±è´¥");
            console.error("èµ„æºè§£æé”™è¯¯:", e);
          }
        } else {
          resourceContent.innerHTML = createEmptyState();
        }
      }

      // æ”¹è¿›çš„èµ„æºå¡ç‰‡åˆ›å»ºå‡½æ•°
      function createResourceCard(resource, index) {
        const card = document.createElement("div");
        card.className = "resource-card";
        card.style.animationDelay = `${index * 0.1}s`;

        let iconType = "ğŸ“š";
        let iconClass = "courseware-icon";
        let title = "å­¦ä¹ èµ„æº";
        let description = "";
        let resourceTime = null;
        let resourceLevel = null;

        // å¤„ç†ä¸åŒæ ¼å¼çš„èµ„æºæ•°æ®
        if (typeof resource === "string") {
          // ç®€å•å­—ç¬¦ä¸²èµ„æº
          description = resource;

          // å°è¯•è§£æJSONå­—ç¬¦ä¸²
          try {
            const parsed = JSON.parse(resource);
            if (parsed.resource_type || parsed.resource) {
              resource = parsed; // è½¬æ¢ä¸ºå¯¹è±¡å¤„ç†
            }
          } catch (e) {
            // å¦‚æœä¸æ˜¯JSONï¼Œç»§ç»­ä½œä¸ºå­—ç¬¦ä¸²å¤„ç†
          }
        }

        // å¤„ç†å¯¹è±¡æ ¼å¼çš„èµ„æº
        if (typeof resource === "object" && resource !== null) {
          // æ£€æŸ¥æ˜¯å¦æœ‰åµŒå¥—çš„resourceå­—æ®µ
          const resourceData = resource.resource || resource;

          // è·å–èµ„æºç±»å‹
          const resourceType =
            resource.resource_type || resourceData.type || "";

          // è·å–å†…å®¹
          const content =
            resourceData.content || resourceData.title || resource.title || "";

          // è®¾ç½®æ ‡é¢˜
          title = resourceType || "å­¦ä¹ èµ„æº";

          // è®¾ç½®æè¿°
          description = content;

          // è·å–æ—¶é—´å’Œç­‰çº§ä¿¡æ¯
          if (resourceData.time) {
            resourceTime = resourceData.time;
          }
          if (resourceData.level) {
            resourceLevel = resourceData.level;
          }

          // æ ¹æ®ç±»å‹è®¾ç½®å›¾æ ‡ - æ–°å¢å››ç§èµ„æºç±»å‹
          if (
            resourceType.includes("è§†é¢‘") ||
            content.includes(".mp4") ||
            content.includes("è§†é¢‘")
          ) {
            iconType = "ğŸ¥";
            iconClass = "video-icon";
          } else if (
            resourceType.includes("è®ºæ–‡") ||
            content.includes(".pdf") ||
            content.includes("è®ºæ–‡")
          ) {
            iconType = "ğŸ“„";
            iconClass = "paper-icon";
          } else if (
            resourceType.includes("è¯¾ä»¶") ||
            content.includes(".ppt") ||
            content.includes("è¯¾ä»¶")
          ) {
            iconType = "ğŸ“Š";
            iconClass = "courseware-icon";
          } else if (
            resourceType.includes("ä¹ é¢˜é›†") ||
            content.includes("ä¹ é¢˜") ||
            content.includes("ç»ƒä¹ ")
          ) {
            iconType = "ğŸ“";
            iconClass = "exercise-icon";
          }
        }

        // æ„å»ºå…ƒæ•°æ®ä¿¡æ¯
        let metaHtml = "";
        if (resourceTime || resourceLevel) {
          metaHtml = `
            <div class="resource-meta">
              ${
                resourceTime
                  ? `<div class="resource-time"><span>â±</span> ${resourceTime} åˆ†é’Ÿ</div>`
                  : ""
              }
              ${
                resourceLevel
                  ? `<div class="resource-level">ç­‰çº§ ${resourceLevel}</div>`
                  : ""
              }
            </div>
          `;
        }

        card.innerHTML = `
          <div class="resource-type-icon ${iconClass}">
            ${iconType}
          </div>
          <div class="resource-title">${title}</div>
          <div class="resource-description">${description}</div>
          ${metaHtml}
        `;

        return card;
      }

      // åˆ›å»ºç©ºçŠ¶æ€
      function createEmptyState(message = "æš‚æ— ç›¸å…³å­¦ä¹ èµ„æº") {
        return `
          <div class="empty-state">
            <div class="empty-illustration">
              <div class="book-stack">
                <div class="book"></div>
                <div class="book"></div>
                <div class="book"></div>
              </div>
              <div class="search-animation">ğŸ”</div>
            </div>
            <div class="empty-message">${message}</div>
            <div class="empty-suggestion">ç»§ç»­å®Œæˆé¢˜ç›®ç»ƒä¹ ï¼Œæ›´å¤šèµ„æºå³å°†æ¨é€ç»™ä½ ï¼</div>
          </div>
        `;
      }

      // æ›´æ–°è®¡æ—¶å™¨çŠ¶æ€
      function updateTimerState() {
        const userData = userAnswers[currentTab][currentIndex];
        const isSubmitted = submittedTabs[currentTab];

        if (isSubmitted) {
          // å·²æäº¤çš„æ¨¡å—æ˜¾ç¤ºè¯¥é¢˜çš„æ€»ç”¨æ—¶
          timerContainer.classList.remove("running");
          timerContainer.classList.add("submitted");
          updateTimerDisplay(userData.accumulatedTime);
        } else {
          // æœªæäº¤çš„æ¨¡å—å¼€å§‹è®¡æ—¶
          timerContainer.classList.remove("submitted");
          startTiming();
        }
      }

      // æ›´æ–°æŒ‰é’®çŠ¶æ€ - ä¿®å¤æäº¤æŒ‰é’®çŠ¶æ€é‡ç½®é—®é¢˜ï¼Œå¹¶æ·»åŠ å®Œæˆæ£€æµ‹æŒ‰é’®é€»è¾‘
      // æ›¿æ¢ updateButtonStates å‡½æ•°
      function updateButtonStates() {
        const isSubmitted = submittedTabs[currentTab];
        const progress = getProgress(currentTab);

        // æç¤ºæŒ‰é’®
        // æç¤ºæŒ‰é’® - ç³»ç»Ÿæé†’æ¨¡å¼ä¸‹ä¸ç¦ç”¨
        if (hintBtn.classList.contains("system-reminder-mode")) {
          hintBtn.disabled = false; // ç³»ç»Ÿæé†’æ¨¡å¼ä¸‹å§‹ç»ˆå¯ç”¨
        } else {
          hintBtn.disabled = isSubmitted; // æ™®é€šæç¤ºæ¨¡å¼ä¸‹æ ¹æ®æäº¤çŠ¶æ€å†³å®š
        }

        // æäº¤æŒ‰é’®çŠ¶æ€é‡ç½® - è¿™æ˜¯å…³é”®ä¿®å¤
        if (isSubmitted) {
          submitBtn.style.display = "none";
          submitBtn.disabled = false; // é‡ç½® disabled çŠ¶æ€
          submitBtn.innerHTML = '<span class="btn-icon">âœ“</span> æäº¤æœ¬æ¨¡å—'; // é‡ç½® innerHTML
          viewReportBtn.style.display = "inline-flex";
        } else {
          viewReportBtn.style.display = "none";
          submitBtn.disabled = false; // ç¡®ä¿æäº¤æŒ‰é’®å¯ç”¨
          submitBtn.innerHTML = '<span class="btn-icon">âœ“</span> æäº¤æœ¬æ¨¡å—'; // ç¡®ä¿æ˜¾ç¤ºæ­£ç¡®çš„æ–‡æœ¬

          // æ— è®ºä»€ä¹ˆé¢˜å‹ï¼Œéƒ½å¿…é¡»å®Œæˆæ‰€æœ‰é¢˜ç›®æ‰èƒ½æäº¤
          submitBtn.style.display =
            progress.done === progress.total ? "inline-flex" : "none";
        }

        // æ›´æ–°å®Œæˆæ£€æµ‹æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
        updateCompleteCheckButtonVisibility();

        // æ›´æ–°æŸ¥çœ‹æç¤ºæŒ‰é’®çŠ¶æ€
        updateHintButtonState();
      }

      // å¼€å§‹è®¡æ—¶
      function startTiming() {
        if (!currentTab || submittedTabs[currentTab]) return;

        const userData = userAnswers[currentTab][currentIndex];

        if (!userData.accumulatedTime) userData.accumulatedTime = 0;

        userData.lastStartTime = Date.now();
        userData.isTiming = true;

        timerContainer.classList.add("running");

        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const currentTime =
            userData.accumulatedTime + (Date.now() - userData.lastStartTime);
          updateTimerDisplay(currentTime);
        }, 200);
      }

      // åœæ­¢å½“å‰è®¡æ—¶
      function stopCurrentTiming() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        timerContainer.classList.remove("running");
      }

      function updateTimerDisplay(milliseconds) {
        const seconds = Math.floor(milliseconds / 1000);
        timerEl.textContent = `${seconds}ç§’`;

        // è‡ªåŠ¨æ›´æ–°å¿ƒæƒ…çŠ¶æ€
        if (moodAutoUpdateEnabled && currentTab) {
          const moodData = userMoods[currentTab][currentIndex];
          let newMoods = [];

          if (seconds <= 15) {
            newMoods = ["ä¸“æ³¨"];
          } else if (seconds <= 60) {
            newMoods = ["ä¸“æ³¨", "å›°æƒ‘"];
          } else if (seconds <= 90) {
            newMoods = ["æ²®ä¸§", "å›°æƒ‘"];
          } else {
            newMoods = ["æ— èŠ", "å›°æƒ‘"];
          }

          // åªæœ‰å½“å¿ƒæƒ…çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶æ‰æ›´æ–°
          if (JSON.stringify(moodData.moods) !== JSON.stringify(newMoods)) {
            moodData.moods = newMoods;
            moodData.autoSelected = true;
            updateMoodPanel();
          }
        }
      }
      // ä¿å­˜å½“å‰ç­”æ¡ˆ
      function saveCurrentAnswer() {
        if (!currentTab || !userAnswers[currentTab]?.[currentIndex]) return;

        const selectedOption = answerContainer.querySelector(
          ".option-item.selected"
        );
        const userData = userAnswers[currentTab][currentIndex];
        console.log(userData);
        if (selectedOption) {
          userData.answer = selectedOption.dataset.value;
        }

        // æ›´æ–°ç´¯è®¡æ—¶é—´
        if (userData.isTiming && userData.lastStartTime) {
          userData.accumulatedTime += Date.now() - userData.lastStartTime;
          userData.lastStartTime = null;
          userData.isTiming = false;
        }
      }

      // åœæ­¢æ‰€æœ‰è®¡æ—¶
      function stopAllTiming() {
        if (!currentTab) return;

        userAnswers[currentTab].forEach((userData) => {
          if (userData.isTiming && userData.lastStartTime) {
            userData.accumulatedTime += Date.now() - userData.lastStartTime;
            userData.lastStartTime = null;
          }
          userData.isTiming = false;
        });

        stopCurrentTiming();
      }

      // æ›´æ–°è¿›åº¦æ¡
      function updateProgressBar() {
        const { done, total } = getProgress(currentTab);
        progressBar.style.width = `${(done / total) * 100}%`;
      }

      // ä¸Šä¸€é¢˜æŒ‰é’®äº‹ä»¶
      // ä¿®æ”¹ä¸Šä¸€é¢˜æŒ‰é’®äº‹ä»¶
      prevBtn.onclick = () => {
        saveCurrentAnswer();
        stopCurrentTiming();

        if (currentIndex > 0) {
          currentIndex--;
          loadQuestion();
        } else {
          loadQuestion();
          feedbackEl.textContent = "ğŸ“ å·²ç»æ˜¯ç¬¬ä¸€é¢˜äº†";
          feedbackEl.className = "error-feedback";
          setTimeout(() => {
            feedbackEl.textContent = "";
            feedbackEl.className = "";
          }, 2000);
        }
        updateMoodPanel(); // æ·»åŠ è¿™è¡Œ
        buildTabs(); // æ›´æ–°æ ‡ç­¾é¡µè¿›åº¦æ˜¾ç¤º
        updateButtonStates(); // ç¡®ä¿æ›´æ–°æŒ‰é’®çŠ¶æ€
      };

      // ä¿®æ”¹ä¸‹ä¸€é¢˜æŒ‰é’®äº‹ä»¶
      nextBtn.onclick = () => {
        console.log(currentTabIndex);
        saveCurrentAnswer();
        stopCurrentTiming();
        updateProgressBar();

        const total = knowledgePoints[currentTab].length;
        if (currentIndex < total - 1) {
          currentIndex++;
          loadQuestion();
        } else {
          loadQuestion();
          feedbackEl.textContent = "ğŸ“ å·²ç»æ˜¯æœ€åä¸€é¢˜äº†";
          feedbackEl.className = "error-feedback";
          setTimeout(() => {
            feedbackEl.textContent = "";
            feedbackEl.className = "";
          }, 2000);
        }
        updateMoodPanel(); // æ·»åŠ è¿™è¡Œ
        buildTabs(); // æ›´æ–°æ ‡ç­¾é¡µè¿›åº¦æ˜¾ç¤º
        updateButtonStates(); // ç¡®ä¿æ›´æ–°æŒ‰é’®çŠ¶æ€
      };

      // ç”ŸæˆæŠ¥å‘Šæ•°æ®
      function generateReportData(tabKey) {
        if (!tabKey || !knowledgePoints[tabKey]) return null;

        const questions = knowledgePoints[tabKey];
        const answers = userAnswers[tabKey];

        const result = {
          knowledgePoint: tabKey,
          totalQuestions: questions.length,
          correctCount: 0,
          incorrectCount: 0,
          totalTime: 0,
          totalHints: 0,
          questions: [],
        };

        questions.forEach((q, i) => {
          const ua = answers[i];
          const correctAnswer = q.answer;
          const userAns = ua.answer;
          const isCorrect = userAns === correctAnswer;

          if (isCorrect) result.correctCount++;
          else result.incorrectCount++;

          result.totalTime += ua.accumulatedTime;
          result.totalHints += hintCounts[tabKey]?.[i] || 0;

          // è·å–ç­”æ¡ˆæ˜¾ç¤ºæ–‡æœ¬
          let userAnswerText = userAns || "æœªä½œç­”";
          let correctAnswerText = correctAnswer;

          if (q.type === "é€‰æ‹©é¢˜" && q.options) {
            if (userAns && q.options[userAns]) {
              userAnswerText = `${userAns}. ${q.options[userAns]}`;
            }
            if (q.options[correctAnswer]) {
              correctAnswerText = `${correctAnswer}. ${q.options[correctAnswer]}`;
            }
          } else if (q.type === "åˆ¤æ–­é¢˜") {
            userAnswerText =
              userAns === "å¯¹"
                ? "å¯¹ (æ­£ç¡®)"
                : userAns === "é”™"
                ? "é”™ (é”™è¯¯)"
                : "æœªä½œç­”";
            correctAnswerText =
              correctAnswer === "å¯¹" ? "å¯¹ (æ­£ç¡®)" : "é”™ (é”™è¯¯)";
          }

          result.questions.push({
            question: q.question,
            questionType: q.type,
            userAnswer: userAnswerText,
            correctAnswer: correctAnswerText,
            isCorrect: isCorrect,
            timeSpent: Math.floor(ua.accumulatedTime / 1000),
            hintCount: hintCounts[tabKey]?.[i] || 0,
            explanation: q.explanation || "",
          });
        });

        return result;
      }

      // æ˜¾ç¤ºæŠ¥å‘Š
      function showReport(reportData) {
        if (!reportData) return;

        reportContainer.innerHTML = "";

        // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
        const accuracy = (
          (reportData.correctCount / reportData.totalQuestions) *
          100
        ).toFixed(1);
        const avgTime = Math.floor(
          reportData.totalTime / reportData.totalQuestions / 1000
        );

        const statsHtml = `
          <div class="report-stats">
            <div class="stat-item stat-correct">
              <div class="stat-value">${accuracy}%</div>
              <div class="stat-label">æ­£ç¡®ç‡</div>
            </div>
            <div class="stat-item stat-time">
              <div class="stat-value">${avgTime}ç§’</div>
              <div class="stat-label">å¹³å‡ç”¨æ—¶</div>
            </div>
            <div class="stat-item stat-hints">
              <div class="stat-value">${reportData.totalHints}</div>
              <div class="stat-label">æ€»æç¤ºæ¬¡æ•°</div>
            </div>
          </div>
        `;
        reportContainer.innerHTML = statsHtml;

        // æ·»åŠ æ¯é“é¢˜è¯¦æƒ…
        reportData.questions.forEach((q, index) => {
          const item = document.createElement("div");
          item.className = `report-item ${
            q.isCorrect ? "correct" : "incorrect"
          }`;

          item.innerHTML = `
            <div class="report-question">
              <span class="question-type-badge ${
                q.questionType === "é€‰æ‹©é¢˜"
                  ? "choice-question"
                  : "judgment-question"
              }">${q.questionType}</span>
              ${index + 1}. ${q.question}
            </div>
            <div class="report-answer">
              <div class="report-label">ä½ çš„ç­”æ¡ˆï¼š</div>
              <div class="report-value ${
                q.isCorrect ? "report-correct" : "report-incorrect"
              }">
                ${q.userAnswer}
              </div>
            </div>
            ${
              !q.isCorrect
                ? `
              <div class="report-answer">
                <div class="report-label">æ­£ç¡®ç­”æ¡ˆï¼š</div>
                <div class="report-value report-correct">${q.correctAnswer}</div>
              </div>
            `
                : ""
            }
            ${
              q.explanation
                ? `
              <div class="report-explanation">
                <div class="report-label">ğŸ“ é¢˜ç›®è§£æï¼š</div>
                <div class="report-explanation-text">${q.explanation}</div>
              </div>
            `
                : ""
            }
            <div class="report-detail">
              <div>â± ç”¨æ—¶: ${q.timeSpent}ç§’</div>
              <div>ğŸ’¡ æç¤º: ${q.hintCount}æ¬¡</div>
            </div>
          `;

          reportContainer.appendChild(item);
        });

        reportModal.style.display = "flex";
      }

      // æäº¤ç­”é¢˜ç»“æœåˆ°åç«¯
      async function submitResultsToBackend(knowledgePoint, reportData) {
        const submitUrl = `http://172.20.192.249:3000/api/learning-paths/${pathId}/submit`;
        const submitData = {
          path_id: pathId,
          user_id: user_id,
          skill_id: rawData[currentTabIndex].skill_id,
          knowledge_point: knowledgePoint,
          total_questions: reportData.totalQuestions,
          correct_count: reportData.correctCount,
          incorrect_count: reportData.incorrectCount,
          submitted_at: new Date().toISOString(),
          questions_detail: reportData.questions.map((q, index) => ({
            question_number: index + 1,
            question_text: q.question,
            question_type: q.questionType,
            user_answer: q.userAnswer,
            correct_answer: q.correctAnswer,
            is_correct: q.isCorrect,
            time_spent: q.timeSpent,
            hint_count: q.hintCount,
          })),
        };
        console.log("æäº¤æ•°æ®:", submitData);

        try {
          const response = await fetch(submitUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(submitData),
          });
          if (response.status != 201) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log("æäº¤ç»“æœ:", result);

          return { success: true, data: result };
        } catch (error) {
          console.error("æäº¤å¤±è´¥:", error);
          return { success: false, error: error.message };
        }
      }

      // æäº¤æŒ‰é’®äº‹ä»¶ - ä¿®æ”¹ä¸ºä¼ é€’æŒæ¡çŠ¶æ€ç»™å¼¹çª—ï¼Œå¹¶æ·»åŠ å®Œæˆæ£€æŸ¥
      submitBtn.onclick = async () => {
        // æ·»åŠ æäº¤ç¡®è®¤
        if (!confirm("ç¡®å®šè¦æäº¤æœ¬æ¨¡å—çš„æ‰€æœ‰ç­”æ¡ˆå—ï¼Ÿæäº¤åå°†æ— æ³•ä¿®æ”¹ã€‚")) {
          return;
        }

        // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading-spinner"></span> æäº¤ä¸­...';

        saveCurrentAnswer();
        stopAllTiming();

        const questions = knowledgePoints[currentTab];
        const answers = userAnswers[currentTab];

        // ç”Ÿæˆå¹¶ä¿å­˜æŠ¥å‘Šæ•°æ®
        const reportData = generateReportData(currentTab);
        tabReports[currentTab] = reportData;

        const correctCount = reportData.correctCount;
        const totalQuestions = reportData.totalQuestions;
        const correctPercentage = (
          (correctCount / totalQuestions) *
          100
        ).toFixed(1);

        // æäº¤ç»“æœåˆ°åç«¯
        const submitResult = await submitResultsToBackend(
          currentTab,
          reportData
        );

        if (submitResult.success) {
          console.log("æäº¤æˆåŠŸ:", submitResult.data);

          // ä¿å­˜å­¦ä¹ æ¬¡æ•°å’ŒæŒæ¡çŠ¶æ€åˆ°æŠ¥å‘Šæ•°æ®ä¸­ï¼Œç”¨äºåç»­åˆ¤æ–­
          tabReports[currentTab].learningCount = submitResult.data.count;
          tabReports[currentTab].masteryResult = (
            submitResult.data.result || ""
          ).trim();

          // æäº¤æˆåŠŸ
          feedbackEl.textContent = `ğŸ‰ æœ¬æ¨¡å—å®Œæˆå¹¶å·²ä¿å­˜ï¼å…± ${totalQuestions} é¢˜ï¼Œæ­£ç¡® ${correctCount} é¢˜ï¼Œæ­£ç¡®ç‡ ${correctPercentage}%ã€‚å­¦ä¹ æ¬¡æ•°ä¸º${submitResult.data.count}ï¼Œæ£€æµ‹ç»“æœä¸ºï¼š${submitResult.data.result}`;
          feedbackEl.className = "success-feedback";

          // æ ‡è®°å½“å‰çŸ¥è¯†ç‚¹ä¸ºå·²æäº¤
          submittedTabs[currentTab] = true;

          // æ£€æŸ¥æ˜¯å¦ä¸º"æœªæŒæ¡"çŠ¶æ€
          const masteryResult = (submitResult.data.result || "").trim();
          const learningCount = submitResult.data.count || 0;

          console.log(
            "æŒæ¡çŠ¶æ€æ£€æŸ¥:",
            masteryResult,
            "å­¦ä¹ æ¬¡æ•°:",
            learningCount
          ); // è°ƒè¯•ä¿¡æ¯

          // æ ¹æ®å­¦ä¹ æ¬¡æ•°å’ŒæŒæ¡çŠ¶æ€å†³å®šå¼¹çª—ç±»å‹
          if (learningCount > 3) {
            console.log("å­¦ä¹ æ¬¡æ•°è¶…è¿‡3æ¬¡ï¼Œæ˜¾ç¤ºå­¦ä¹ è·¯å¾„æ›´æ¢å¼¹çª—"); // è°ƒè¯•ä¿¡æ¯
            setTimeout(() => {
              showPathChangeModal();
            }, 2000); // 2ç§’åæ˜¾ç¤ºå¼¹çª—ï¼Œè®©ç”¨æˆ·å…ˆçœ‹åˆ°æäº¤ç»“æœ
          } else if (masteryResult === "æœªæŒæ¡") {
            console.log("æ£€æµ‹åˆ°æœªæŒæ¡çŠ¶æ€ï¼Œæ˜¾ç¤ºæ›´æ¢èµ„æºå¼¹çª—"); // è°ƒè¯•ä¿¡æ¯
            setTimeout(() => {
              // ä¼ å…¥å®é™…çš„æŒæ¡çŠ¶æ€
              showResourceChangeModal(masteryResult);
            }, 2000); // 2ç§’åæ˜¾ç¤ºå¼¹çª—ï¼Œè®©ç”¨æˆ·å…ˆçœ‹åˆ°æäº¤ç»“æœ
          } else {
            console.log("æŒæ¡çŠ¶æ€è‰¯å¥½ï¼Œæ— éœ€æ˜¾ç¤ºå¼¹çª—"); // è°ƒè¯•ä¿¡æ¯
          }

          // è§£é”ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹ - ä¿®å¤è§£é”é€»è¾‘
          const currentKeyIndex = keys.indexOf(currentTab);
          if (masteryResult !== "æœªæŒæ¡") {
            // åªæœ‰æŒæ¡äº†æ‰è§£é”ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹
            if (currentKeyIndex !== -1 && currentKeyIndex < keys.length - 1) {
              const nextKey = keys[currentKeyIndex + 1];
              unlockedTabs[nextKey] = true;
              console.log("è§£é”ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹:", nextKey);
            }
          } else {
            // å¦‚æœæœªæŒæ¡ï¼Œä¸è§£é”ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹
            console.log("å½“å‰çŸ¥è¯†ç‚¹æœªæŒæ¡ï¼Œä¸è§£é”ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹");
          }

          // æ›´æ–°ç•Œé¢
          buildTabs();
          updateButtonStates();
          updateProgressBar(); // ç¡®ä¿è¿›åº¦æ¡æ›´æ–°åˆ°100%

          // ç¦ç”¨ç­”æ¡ˆé€‰æ‹©
          answerContainer.className = "disabled";

          // æ›´æ–°è®¡æ—¶å™¨çŠ¶æ€
          timerContainer.classList.remove("running");
          timerContainer.classList.add("submitted");

          // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰çŸ¥è¯†ç‚¹éƒ½å·²å®Œæˆ
          checkAllKnowledgePointsCompleted();
        } else {
          // æäº¤å¤±è´¥
          feedbackEl.textContent = `âŒ æäº¤å¤±è´¥ï¼š${submitResult.error}ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚`;
          feedbackEl.className = "error-feedback";

          // æ¢å¤æäº¤æŒ‰é’®
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<span class="btn-icon">âœ“</span> æäº¤æœ¬æ¨¡å—';

          // æ˜¾ç¤ºé‡è¯•æç¤º
          setTimeout(() => {
            if (confirm("æäº¤å¤±è´¥ï¼Œæ˜¯å¦é‡è¯•ï¼Ÿ")) {
              submitBtn.click(); // é‡æ–°è§¦å‘æäº¤
            }
          }, 2000);
        }
      };

      // æŸ¥çœ‹æŠ¥å‘ŠæŒ‰é’®äº‹ä»¶
      viewReportBtn.onclick = () => {
        if (!submittedTabs[currentTab]) return;

        const reportData = tabReports[currentTab];
        if (reportData) {
          showReport(reportData);
        }
      };

      // å…³é—­æ¨¡æ€æ¡†äº‹ä»¶
      closeModal.onclick = () => {
        reportModal.style.display = "none";
      };

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      window.onclick = (event) => {
        if (event.target === reportModal) {
          reportModal.style.display = "none";
        }
      };

      // ESCé”®å…³é—­æ¨¡æ€æ¡†
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && reportModal.style.display === "flex") {
          reportModal.style.display = "none";
        }
        if (
          e.key === "Escape" &&
          resourceChangeModal.style.display === "flex"
        ) {
          hideResourceChangeModal();
        }
        if (e.key === "Escape" && pathChangeModal.style.display === "flex") {
          hidePathChangeModal();
        }
        if (e.key === "Escape" && pathSelectionModal.style.display === "flex") {
          hidePathSelectionModal();
        }
        if (e.key === "Escape" && returnHomeModal.style.display === "flex") {
          hideReturnHomeModal();
        }
        if (
          e.key === "Escape" &&
          completionReminderModal.style.display === "flex"
        ) {
          hideCompletionReminderModal();
        }
      });

      // åˆå§‹åŒ–åº”ç”¨
      init();

      // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤„ç†è®¡æ—¶
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          // é¡µé¢éšè—æ—¶æš‚åœè®¡æ—¶
          if (timerInterval) {
            saveCurrentAnswer();
          }
        } else {
          // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤è®¡æ—¶ï¼ˆä»…å½“åœ¨é¢˜ç›®é¢æ¿æ—¶ï¼‰
          if (
            currentTab &&
            !submittedTabs[currentTab] &&
            document
              .getElementById("question-panel")
              .classList.contains("active")
          ) {
            startTiming();
          }
        }
      });

      // æ–°å¢ï¼šé¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
      document.addEventListener("DOMContentLoaded", function () {
        // åˆå§‹åŒ–å®Œæˆæ£€æµ‹æŒ‰é’®çŠ¶æ€
        updateCompleteCheckButtonVisibility();
        // åˆå§‹åŒ–æŸ¥çœ‹æç¤ºæŒ‰é’®çŠ¶æ€
        updateHintButtonState();
      });
    </script>
  </body>
</html>
